<!DOCTYPE html>
<html lang="ru" data-theme="blue">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Nexus</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THEMES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
[data-theme="blue"]{
  --acc:#2b8af5;--acc2:#1e5fd4;--accH:#3b9bff;
  --accS:rgba(43,138,245,.15);--accG:linear-gradient(135deg,#2b8af5,#7c5ce4);
  --glow:0 0 30px rgba(43,138,245,.4);
}
[data-theme="purple"]{
  --acc:#8b5cf6;--acc2:#6d28d9;--accH:#a78bfa;
  --accS:rgba(139,92,246,.15);--accG:linear-gradient(135deg,#8b5cf6,#ec4899);
  --glow:0 0 30px rgba(139,92,246,.4);
}
[data-theme="green"]{
  --acc:#10b981;--acc2:#059669;--accH:#34d399;
  --accS:rgba(16,185,129,.15);--accG:linear-gradient(135deg,#10b981,#2b8af5);
  --glow:0 0 30px rgba(16,185,129,.4);
}
[data-theme="red"]{
  --acc:#ef4444;--acc2:#dc2626;--accH:#f87171;
  --accS:rgba(239,68,68,.15);--accG:linear-gradient(135deg,#ef4444,#f97316);
  --glow:0 0 30px rgba(239,68,68,.4);
}
[data-theme="gold"]{
  --acc:#f59e0b;--acc2:#d97706;--accH:#fbbf24;
  --accS:rgba(245,158,11,.15);--accG:linear-gradient(135deg,#f59e0b,#ef4444);
  --glow:0 0 30px rgba(245,158,11,.4);
}

:root{
  --bg:#080a12;--bg2:#0d1120;--bg3:#111827;--bg4:#1a2035;--bg5:#1e2640;
  --brd:rgba(43,138,245,.1);--brd2:rgba(43,138,245,.2);--brd3:rgba(255,255,255,.06);
  --grn:#22c55e;--red:#f87171;--ylw:#fbbf24;--org:#fb923c;
  --tx:#dde4f5;--tx2:#7a8fb5;--tx3:#3d4f70;
  --out:#0e2050;--outB:rgba(43,138,245,.3);
  --in:#111827;--inB:rgba(255,255,255,.05);
  --sb:300px;--ease:cubic-bezier(.4,0,.2,1);--t:.18s;
  --safe:env(safe-area-inset-bottom,0px);
  --shadow:0 8px 32px rgba(0,0,0,.6);
  --shadow2:0 2px 12px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;height:-webkit-fill-available;overflow:hidden;font-family:'Inter',sans-serif;background:var(--bg);color:var(--tx);-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:2px;}
input,textarea,button,select{font-family:inherit;-webkit-appearance:none;outline:none;}
a{color:var(--acc);}

/* ‚ïê‚ïê PARTICLES BG ‚ïê‚ïê */
.particles{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.particle{position:absolute;border-radius:50%;animation:pFloat linear infinite;opacity:0;}
@keyframes pFloat{0%{transform:translateY(100vh)rotate(0);opacity:0;}10%{opacity:.4;}90%{opacity:.2;}100%{transform:translateY(-100px)rotate(720deg);opacity:0;}}

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
#auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;overflow-y:auto;padding:20px;}
.auth-bg{position:absolute;inset:0;background:var(--bg);}
.auth-orb{position:absolute;border-radius:50%;filter:blur(100px);animation:orbFloat 10s ease-in-out infinite;}
.ao1{width:600px;height:600px;background:rgba(43,138,245,.08);top:-200px;left:-200px;}
.ao2{width:500px;height:500px;background:rgba(124,92,228,.07);bottom:-150px;right:-150px;animation-delay:-4s;}
.ao3{width:300px;height:300px;background:rgba(34,197,94,.05);top:30%;left:60%;animation-delay:-7s;}
@keyframes orbFloat{0%,100%{transform:translate(0,0);}33%{transform:translate(30px,-40px);}66%{transform:translate(-25px,30px);}}
.auth-wrap{width:100%;max-width:420px;position:relative;z-index:1;}
.auth-card{background:rgba(13,17,32,.95);border:1px solid var(--brd2);border-radius:28px;padding:40px 34px;backdrop-filter:blur(30px);box-shadow:0 40px 100px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.06);animation:authIn .6s var(--ease) both;}
@keyframes authIn{from{opacity:0;transform:translateY(40px)scale(.95)}to{opacity:1;transform:none}}
/* Logo */
.auth-logo{display:flex;flex-direction:column;align-items:center;gap:14px;margin-bottom:32px;}
.auth-logo-icon{width:72px;height:72px;position:relative;animation:logoSpin 0s;cursor:default;}
.logo-bg{width:72px;height:72px;border-radius:22px;background:var(--accG);display:flex;align-items:center;justify-content:center;box-shadow:var(--glow),inset 0 1px 0 rgba(255,255,255,.2);position:relative;overflow:hidden;}
.logo-bg::before{content:'';position:absolute;inset:-50%;background:conic-gradient(transparent,rgba(255,255,255,.15),transparent 60%);animation:logoRot 4s linear infinite;}
@keyframes logoRot{to{transform:rotate(360deg);}}
.logo-inner{position:relative;z-index:1;font-size:34px;line-height:1;}
.auth-title{font-size:32px;font-weight:900;letter-spacing:-1.5px;background:linear-gradient(135deg,#fff,var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.auth-sub{font-size:13px;color:var(--tx3);font-weight:500;}
/* Tabs */
.auth-tabs{display:flex;background:var(--bg3);border-radius:14px;padding:4px;margin-bottom:24px;border:1px solid var(--brd);}
.at{flex:1;padding:10px;border:none;background:none;color:var(--tx3);font-size:13.5px;font-weight:600;border-radius:10px;cursor:pointer;transition:all var(--t);}
.at.act{background:var(--accG);color:#fff;box-shadow:0 4px 14px rgba(43,138,245,.35);}
/* Fields */
.afields{display:flex;flex-direction:column;gap:14px;}
.afield{position:relative;}
.afield-ic{position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none;z-index:1;}
.afield-pre{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--tx3);font-weight:700;font-size:14px;pointer-events:none;z-index:1;}
.ainp{width:100%;background:var(--bg4);border:1.5px solid var(--brd);border-radius:14px;padding:14px 15px;color:var(--tx);font-size:14px;transition:all var(--t);}
.ainp.ic{padding-left:46px;}
.ainp.pre{padding-left:30px;}
.ainp:focus{border-color:var(--acc);background:var(--bg5);box-shadow:0 0 0 4px var(--accS);}
.ainp::placeholder{color:var(--tx3);}
.ahint{font-size:11.5px;color:var(--tx3);padding:0 3px;line-height:1.6;margin-top:-6px;}
.aerr{display:flex;align-items:center;gap:8px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.25);border-radius:10px;padding:10px 13px;font-size:12.5px;color:var(--red);min-height:0;transition:all .2s;}
.aerr.hidden{display:none;}
.abtn{width:100%;padding:15px;border:none;border-radius:14px;background:var(--accG);color:#fff;font-size:15px;font-weight:700;cursor:pointer;letter-spacing:.3px;box-shadow:0 8px 28px rgba(43,138,245,.4);transition:all var(--t);position:relative;overflow:hidden;}
.abtn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);opacity:0;transition:opacity var(--t);}
.abtn:hover::after{opacity:1;}
.abtn:hover{transform:translateY(-2px);box-shadow:0 14px 36px rgba(43,138,245,.5);}
.abtn:active{transform:none;}

/* ‚ïê‚ïê WELCOME ANIMATION ‚ïê‚ïê */
#welcome-screen{position:fixed;inset:0;z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);gap:20px;animation:wIn .4s var(--ease);}
@keyframes wIn{from{opacity:0}to{opacity:1}}
.welcome-logo{width:100px;height:100px;border-radius:28px;background:var(--accG);display:flex;align-items:center;justify-content:center;font-size:50px;box-shadow:var(--glow);animation:wBounce 1s var(--ease) .2s both;}
@keyframes wBounce{0%{transform:scale(0)rotate(-20deg)}60%{transform:scale(1.15)rotate(5deg)}100%{transform:scale(1)rotate(0)}}
.welcome-title{font-size:28px;font-weight:900;animation:wFade .6s var(--ease) .5s both;}
@keyframes wFade{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:none}}
.welcome-sub{font-size:14px;color:var(--tx2);animation:wFade .6s var(--ease) .7s both;text-align:center;max-width:280px;line-height:1.6;}
.welcome-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.conf{position:absolute;width:8px;height:8px;border-radius:2px;animation:confFall linear forwards;}
@keyframes confFall{0%{transform:translateY(-20px)rotate(0);opacity:1;}100%{transform:translateY(110vh)rotate(720deg);opacity:0;}}

/* ‚ïê‚ïê APP ‚ïê‚ïê */
#app{display:flex;height:100%;height:-webkit-fill-available;opacity:0;transition:opacity .3s;position:relative;z-index:1;}
#app.show{opacity:1;}

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
.sb{width:var(--sb);min-width:var(--sb);background:var(--bg2);border-right:1px solid var(--brd);display:flex;flex-direction:column;transition:transform .3s var(--ease);z-index:20;flex-shrink:0;box-shadow:4px 0 20px rgba(0,0,0,.3);}
@media(max-width:768px){
  .sb{position:fixed;inset:0 auto 0 0;width:100%;min-width:0;transform:translateX(-100%);}
  .sb.open{transform:none;}
}
.sb-head{padding:12px 10px 8px;flex-shrink:0;}
.sb-top{display:flex;align-items:center;gap:6px;margin-bottom:10px;}
.sb-brand{display:flex;align-items:center;gap:9px;flex:1;min-width:0;}
.sb-logo{width:34px;height:34px;border-radius:10px;background:var(--accG);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;box-shadow:var(--glow);}
.sb-title{font-size:17px;font-weight:900;letter-spacing:-.5px;background:linear-gradient(135deg,#fff,var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.ib{width:32px;height:32px;border:none;border-radius:9px;background:transparent;color:var(--tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all var(--t);flex-shrink:0;}
.ib:hover{background:var(--bg4);color:var(--tx);box-shadow:var(--shadow2);}
.ib:active{transform:scale(.9);}
.sb-srch{position:relative;margin-bottom:4px;}
.sb-si{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--tx3);pointer-events:none;display:flex;}
.sb-inp{width:100%;background:var(--bg3);border:1px solid var(--brd);border-radius:10px;padding:9px 10px 9px 33px;color:var(--tx);font-size:13.5px;transition:border-color var(--t);}
.sb-inp:focus{border-color:var(--acc);}
.sb-inp::placeholder{color:var(--tx3);}
.chat-list{flex:1;overflow-y:auto;padding:4px 6px;}
.sec-l{font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.9px;padding:8px 6px 3px;display:flex;align-items:center;gap:6px;}
.sec-l::after{content:'';flex:1;height:1px;background:var(--brd);}
/* Chat item */
.ci{display:flex;align-items:center;gap:10px;padding:8px 8px;border-radius:13px;cursor:pointer;transition:all var(--t);position:relative;}
.ci:hover{background:var(--bg3);box-shadow:var(--shadow2);}
.ci:active{transform:scale(.98);}
.ci.act{background:var(--accS);border:1px solid var(--brd2);}
.ci.act .ci-name{color:var(--acc);}
.ci-pin{position:absolute;top:6px;right:8px;font-size:9px;color:var(--tx3);}
/* Avatar */
.ava{position:relative;flex-shrink:0;}
.av{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0;position:relative;}
.av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.av-xl{width:60px;height:60px;font-size:24px;}
.av-lg{width:46px;height:46px;font-size:19px;}
.av-md{width:38px;height:38px;font-size:15px;}
.av-sm{width:30px;height:30px;font-size:12px;}
.av-xs{width:23px;height:23px;font-size:9px;}
.on-dot{position:absolute;border-radius:50%;background:var(--grn);border:2.5px solid var(--bg2);bottom:-1px;right:-1px;z-index:2;}
.on-dot.lg{width:14px;height:14px;}
.on-dot.md{width:12px;height:12px;}
.on-dot.sm{width:10px;height:10px;border-width:2px;}
.verified-badge{position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;background:var(--acc);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;border:2px solid var(--bg2);z-index:3;}
.verified-inline{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;background:var(--acc);border-radius:50%;font-size:8px;margin-left:3px;vertical-align:middle;flex-shrink:0;}
.creator-badge{display:inline-flex;align-items:center;gap:3px;background:linear-gradient(135deg,var(--ylw),var(--org));border-radius:6px;padding:2px 6px;font-size:9px;font-weight:800;color:#000;margin-left:4px;}
.ci-info{flex:1;min-width:0;}
.ci-top{display:flex;align-items:baseline;justify-content:space-between;gap:4px;margin-bottom:2px;}
.ci-name{font-size:13.5px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;display:flex;align-items:center;gap:2px;}
.ci-time{font-size:11px;color:var(--tx3);flex-shrink:0;}
.ci-bot{display:flex;align-items:center;justify-content:space-between;gap:4px;}
.ci-prev{font-size:12px;color:var(--tx2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.ci-badge{background:var(--accG);color:#fff;font-size:10.5px;font-weight:700;padding:2px 7px;border-radius:20px;flex-shrink:0;}
.ci-muted{color:var(--tx3);font-size:12px;}
.empty-sb{padding:32px 14px;text-align:center;color:var(--tx3);font-size:13px;line-height:1.8;}
/* Sidebar footer */
.sb-foot{border-top:1px solid var(--brd);padding:10px;display:flex;align-items:center;gap:9px;flex-shrink:0;padding-bottom:calc(10px + var(--safe));}
.me-inf{flex:1;min-width:0;}
.me-name{font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center;gap:4px;}
.me-status{font-size:11px;color:var(--grn);}

/* ‚ïê‚ïê MAIN ‚ïê‚ïê */
.main{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg);overflow:hidden;}
.placeholder{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.ph-icon{font-size:64px;opacity:.15;filter:drop-shadow(var(--glow));}
.ph-t{font-size:16px;color:var(--tx3);font-weight:600;}
.ph-s{font-size:13px;color:var(--tx3);}

/* Chat header */
.ch{background:rgba(13,17,32,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);padding:10px 14px;display:flex;align-items:center;gap:11px;flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,.3);}
.ch-back{display:none;}
@media(max-width:768px){.ch-back{display:flex;}}
.ch-info{flex:1;min-width:0;cursor:pointer;}
.ch-name{font-size:14px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center;gap:5px;}
.ch-sub{font-size:11.5px;color:var(--tx2);}
.ch-tag{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:700;}
.ch-tag.ch{background:rgba(245,158,11,.15);color:var(--ylw);}
.ch-tag.gr{background:rgba(34,197,94,.12);color:var(--grn);}

/* Pinned bar */
.pin-bar{background:linear-gradient(90deg,var(--accS),transparent);border-bottom:1px solid var(--brd);padding:7px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;flex-shrink:0;}
.pin-ic{font-size:13px;color:var(--acc);}
.pin-txt{flex:1;min-width:0;}
.pin-lbl{font-size:10px;color:var(--acc);font-weight:700;display:block;margin-bottom:1px;}
.pin-val{font-size:12px;color:var(--tx2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block;}

/* Messages */
.msgs{flex:1;overflow-y:auto;padding:14px 16px 6px;display:flex;flex-direction:column;gap:2px;overscroll-behavior:contain;}
.msgs-bg{background-image:radial-gradient(circle at 20% 50%,rgba(43,138,245,.03) 0%,transparent 60%),radial-gradient(circle at 80% 20%,rgba(124,92,228,.03) 0%,transparent 60%);}
.date-sep{display:flex;align-items:center;gap:10px;padding:10px 0 5px;color:var(--tx3);font-size:10.5px;font-weight:600;}
.date-sep::before,.date-sep::after{content:'';flex:1;height:1px;background:var(--brd);}
/* Message row */
.mr{display:flex;align-items:flex-end;gap:7px;padding:1px 0;}
.mr.out{flex-direction:row-reverse;}
.mr.out .mava{display:none;}
.mava{flex-shrink:0;margin-bottom:3px;}
.mbub{max-width:72%;padding:9px 12px 7px;border-radius:18px;position:relative;word-wrap:break-word;animation:mpop .15s var(--ease) both;transition:box-shadow var(--t);}
@keyframes mpop{from{opacity:0;transform:scale(.93)translateY(5px)}to{opacity:1;transform:none}}
@media(max-width:768px){.mbub{max-width:87%;}}
.mr.in .mbub{background:var(--in);border:1px solid var(--inB);border-bottom-left-radius:5px;box-shadow:var(--shadow2);}
.mr.out .mbub{background:var(--out);border:1px solid var(--outB);border-bottom-right-radius:5px;box-shadow:0 2px 12px rgba(43,138,245,.15);}
.mbub:hover{box-shadow:0 4px 20px rgba(0,0,0,.4);}
.m-sender{font-size:11px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
.m-rbadge{font-size:9px;padding:1.5px 5px;border-radius:4px;font-weight:700;}
.m-rbadge.admin{background:rgba(43,138,245,.2);color:var(--acc);}
.m-rbadge.mod{background:rgba(34,197,94,.15);color:var(--grn);}
.m-rbadge.owner{background:rgba(245,158,11,.15);color:var(--ylw);}
.m-text{font-size:14px;line-height:1.55;display:block;white-space:pre-wrap;word-break:break-word;}
.m-caption{font-size:13px;line-height:1.5;display:block;white-space:pre-wrap;word-break:break-word;margin-top:5px;opacity:.9;}
/* Meta */
.m-meta{display:flex;align-items:center;justify-content:flex-end;gap:4px;margin-top:4px;}
.m-time{font-size:10.5px;color:var(--tx3);}
.m-edited{font-size:10px;color:var(--tx3);font-style:italic;}
.m-pin-ic{font-size:9px;color:var(--acc);}
/* Beautiful ticks */
.m-ticks{display:flex;align-items:center;flex-shrink:0;margin-left:1px;}
.tick-svg{overflow:visible;}
/* Hover actions */
.mbub:hover .macts,.mbub:focus-within .macts{opacity:1;pointer-events:auto;}
.macts{position:absolute;top:-38px;right:0;background:var(--bg4);border:1px solid var(--brd2);border-radius:12px;display:flex;overflow:hidden;opacity:0;pointer-events:none;transition:opacity var(--t);box-shadow:0 6px 24px rgba(0,0,0,.6);z-index:10;backdrop-filter:blur(10px);}
.mr.in .macts{right:auto;left:0;}
.mab{padding:7px 11px;background:none;border:none;color:var(--tx2);font-size:13px;cursor:pointer;transition:all var(--t);}
.mab:hover{background:var(--bg5);color:var(--tx);}
.mab.del:hover{color:var(--red);}
/* File */
.m-file{display:flex;align-items:center;gap:10px;padding:3px 0;}
.mf-ic{width:42px;height:42px;border-radius:12px;background:var(--accS);display:flex;align-items:center;justify-content:center;font-size:21px;flex-shrink:0;}
.mf-info{flex:1;min-width:0;}
.mf-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mf-size{font-size:11px;color:var(--tx3);}
.mf-dl{background:none;border:none;color:var(--acc);font-size:18px;cursor:pointer;padding:4px;border-radius:8px;transition:background var(--t);}
.mf-dl:hover{background:var(--accS);}
/* Voice */
.m-voice{display:flex;align-items:center;gap:10px;min-width:200px;padding:3px 0;}
@media(max-width:480px){.m-voice{min-width:160px;}}
.vplay{width:42px;height:42px;border-radius:50%;background:var(--accG);border:none;color:#fff;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all var(--t);box-shadow:var(--glow);}
.vplay:hover{transform:scale(1.1);}
.vplay:active{transform:scale(.94);}
.vcenter{flex:1;display:flex;flex-direction:column;gap:5px;min-width:0;}
.waveform{display:flex;align-items:center;gap:2px;height:32px;cursor:pointer;user-select:none;}
.wb{flex-shrink:0;width:3px;border-radius:3px;background:rgba(255,255,255,.18);transition:background .08s;}
.wb.p{background:var(--acc);}
.mr.out .wb{background:rgba(255,255,255,.25);}
.mr.out .wb.p{background:#60a5fa;}
.v-bot{display:flex;align-items:center;justify-content:space-between;}
.v-dur{font-size:11px;color:var(--tx3);font-variant-numeric:tabular-nums;}
/* Typing */
.typ-wrap{min-height:28px;padding:3px 16px 6px;display:flex;align-items:center;gap:9px;flex-shrink:0;}
.typ-avas{display:flex;}
.typ-avas .av{margin-left:-7px;border:2.5px solid var(--bg);}
.typ-avas .av:first-child{margin-left:0;}
.typ-right{display:flex;align-items:center;gap:7px;}
.typ-text{font-size:12px;color:var(--tx2);font-style:italic;}
.typ-dots{display:flex;gap:3px;align-items:center;}
.typ-dots span{width:5px;height:5px;border-radius:50%;background:var(--acc);animation:td 1.2s ease-in-out infinite;}
.typ-dots span:nth-child(2){animation-delay:.2s;}
.typ-dots span:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,60%,100%{transform:scale(1);opacity:.4}30%{transform:scale(1.5);opacity:1}}
/* Input area */
.input-area{background:rgba(13,17,32,.9);backdrop-filter:blur(20px);border-top:1px solid var(--brd);padding:8px 12px;flex-shrink:0;padding-bottom:calc(8px + var(--safe));}
.edit-notice{display:flex;align-items:center;justify-content:space-between;background:var(--bg4);border-left:3px solid var(--acc);border-radius:0 10px 10px 0;padding:6px 11px;margin-bottom:8px;font-size:12px;color:var(--tx2);}
.en-x{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:19px;transition:color var(--t);}
.en-x:hover{color:var(--tx);}
.pf-bar{display:flex;align-items:center;gap:8px;background:var(--bg4);border-radius:12px;padding:9px 12px;margin-bottom:8px;border:1px solid var(--brd);}
.pf-ico{font-size:20px;flex-shrink:0;}
.pf-nm{flex:1;font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pf-sz{font-size:11px;color:var(--tx3);}
.pf-rm{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:17px;transition:color var(--t);}
.pf-rm:hover{color:var(--red);}
.ch-notice{text-align:center;padding:8px;font-size:12.5px;color:var(--tx3);font-style:italic;}
.irow{display:flex;align-items:flex-end;gap:7px;}
.tb{width:40px;height:40px;border:none;border-radius:11px;background:var(--bg4);color:var(--tx2);font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--t);flex-shrink:0;border:1px solid var(--brd);}
.tb:hover{background:var(--bg5);color:var(--tx);border-color:var(--acc);}
.tb:active{transform:scale(.9);}
.tb.recording{background:rgba(248,113,113,.15);color:var(--red);border-color:rgba(248,113,113,.3);animation:recP 1s infinite;}
@keyframes recP{0%,100%{box-shadow:none}50%{box-shadow:0 0 10px rgba(248,113,113,.4);}}
.msg-ta{flex:1;background:var(--bg4);border:1.5px solid var(--brd);border-radius:14px;padding:11px 13px;color:var(--tx);font-size:14px;resize:none;max-height:120px;min-height:42px;line-height:1.5;transition:border-color var(--t);}
.msg-ta:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--accS);}
.msg-ta::placeholder{color:var(--tx3);}
.rec-ind{display:none;align-items:center;gap:8px;flex:1;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:12px;padding:8px 13px;}
.rec-dot{width:8px;height:8px;border-radius:50%;background:var(--red);animation:rb 1s infinite;}
@keyframes rb{0%,100%{opacity:1}50%{opacity:.3}}
.rec-t{font-size:13px;color:var(--red);font-weight:600;font-variant-numeric:tabular-nums;}
.send-btn{width:42px;height:42px;border:none;border-radius:12px;background:var(--accG);color:#fff;font-size:17px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all var(--t);box-shadow:0 4px 16px rgba(43,138,245,.4);}
.send-btn:hover{transform:scale(1.07);box-shadow:0 6px 22px rgba(43,138,245,.5);}
.send-btn:active{transform:scale(.93);}
/* Emoji picker */
.emj-picker{position:absolute;left:0;right:0;background:rgba(13,17,32,.97);border:1px solid var(--brd2);border-radius:20px 20px 0 0;padding:14px 12px 10px;z-index:50;box-shadow:0 -12px 40px rgba(0,0,0,.7);backdrop-filter:blur(20px);animation:eIn .18s var(--ease) both;}
@keyframes eIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
.emj-tabs{display:flex;gap:2px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px;}
.emj-tabs::-webkit-scrollbar{display:none;}
.emj-tab{background:none;border:none;font-size:22px;cursor:pointer;padding:5px 7px;border-radius:10px;transition:background var(--t);flex-shrink:0;}
.emj-tab.act,.emj-tab:hover{background:var(--bg4);}
.emj-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;max-height:160px;overflow-y:auto;}
@media(max-width:400px){.emj-grid{grid-template-columns:repeat(6,1fr);}}
.emj-btn{background:none;border:none;font-size:24px;cursor:pointer;padding:5px;border-radius:9px;transition:background var(--t);text-align:center;}
.emj-btn:hover{background:var(--bg4);}

/* ‚ïê‚ïê SETTINGS PANEL (LEFT) ‚ïê‚ïê */
.settings-ov{position:fixed;inset:0;z-index:90;opacity:0;pointer-events:none;transition:opacity .25s;}
.settings-ov.open{opacity:1;pointer-events:auto;}
.settings-bg{position:absolute;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);}
.settings-panel{position:absolute;top:0;left:0;bottom:0;width:340px;background:var(--bg2);border-right:1px solid var(--brd);transform:translateX(-100%);transition:transform .3s var(--ease);display:flex;flex-direction:column;box-shadow:4px 0 40px rgba(0,0,0,.6);}
@media(max-width:768px){.settings-panel{width:100%;border-right:none;}}
.settings-ov.open .settings-panel{transform:none;}
/* Settings top - avatar centered */
.s-top{padding:28px 20px 20px;text-align:center;background:linear-gradient(180deg,var(--bg3),var(--bg2));border-bottom:1px solid var(--brd);flex-shrink:0;position:relative;}
.s-close{position:absolute;top:12px;right:12px;}
.s-av-wrap{display:flex;justify-content:center;margin-bottom:12px;position:relative;cursor:pointer;}
.s-username{font-size:14px;color:var(--tx2);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:5px;}
.s-displayname{font-size:18px;font-weight:800;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:6px;}
.s-online{font-size:11px;color:var(--grn);font-weight:500;}
.s-body{flex:1;overflow-y:auto;padding:12px 14px;}
.s-sec{margin-bottom:6px;}
.s-sec-title{font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;padding:10px 6px 5px;display:flex;align-items:center;gap:6px;}
.s-sec-title::after{content:'';flex:1;height:1px;background:var(--brd);}
.s-row{display:flex;align-items:center;gap:11px;padding:11px 12px;border-radius:12px;cursor:pointer;transition:all var(--t);}
.s-row:hover{background:var(--bg4);box-shadow:var(--shadow2);}
.s-row:active{transform:scale(.98);}
.s-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.s-info{flex:1;min-width:0;}
.s-n{font-size:13px;font-weight:600;}
.s-s{font-size:11px;color:var(--tx3);margin-top:1px;}
.s-r{color:var(--tx3);font-size:13px;margin-left:auto;}
/* Toggle */
.tog{position:relative;width:42px;height:23px;flex-shrink:0;}
.tog input{opacity:0;width:0;height:0;position:absolute;}
.tog-tr{position:absolute;inset:0;background:var(--bg5);border-radius:20px;cursor:pointer;transition:background var(--t);}
.tog input:checked~.tog-tr{background:var(--acc);}
.tog-th{position:absolute;top:2.5px;left:2.5px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform var(--t);pointer-events:none;box-shadow:0 2px 6px rgba(0,0,0,.3);}
.tog input:checked~.tog-th{transform:translateX(19px);}
/* Theme selector */
.theme-grid{display:flex;gap:8px;flex-wrap:wrap;padding:0 4px;}
.theme-btn{width:36px;height:36px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all var(--t);position:relative;box-shadow:var(--shadow2);}
.theme-btn.act::after{content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:700;}
.theme-btn:hover{transform:scale(1.15);}
/* Multi-account */
.accs-list{display:flex;flex-direction:column;gap:4px;padding:0 2px;}
.acc-row{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:10px;cursor:pointer;transition:background var(--t);background:var(--bg3);}
.acc-row:hover{background:var(--bg4);}
.acc-row.active-acc{border:1px solid var(--acc);}
.acc-name{flex:1;font-size:13px;font-weight:600;}
.acc-un{font-size:11px;color:var(--tx3);}
.add-acc-btn{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:10px;cursor:pointer;border:1.5px dashed var(--brd2);color:var(--tx3);font-size:13px;font-weight:600;transition:all var(--t);}
.add-acc-btn:hover{border-color:var(--acc);color:var(--acc);background:var(--accS);}
.dz{margin-top:2px;padding:12px;background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.15);border-radius:12px;}
.btn-danger{width:100%;padding:11px;background:none;border:1px solid rgba(248,113,113,.35);border-radius:10px;color:var(--red);font-size:13.5px;font-weight:600;cursor:pointer;transition:all var(--t);text-align:left;display:flex;align-items:center;gap:8px;}
.btn-danger:hover{background:rgba(248,113,113,.12);}

/* Admin panel */
.admin-row{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:10px;background:var(--bg3);border:1px solid var(--brd);}
.admin-row:hover{background:var(--bg4);}
.admin-info{flex:1;min-width:0;}
.admin-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:4px;}
.admin-un{font-size:11px;color:var(--tx3);}
.admin-btns{display:flex;gap:4px;flex-shrink:0;}
.admin-btn{padding:4px 8px;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;transition:all var(--t);}
.admin-btn.verify{background:rgba(43,138,245,.15);color:var(--acc);}
.admin-btn.verify:hover{background:var(--acc);color:#fff;}
.admin-btn.ban{background:rgba(248,113,113,.12);color:var(--red);}
.admin-btn.ban:hover{background:var(--red);color:#fff;}
.admin-btn.del{background:rgba(80,80,80,.2);color:var(--tx2);}
.admin-btn.del:hover{background:var(--red);color:#fff;}

/* ‚ïê‚ïê PANEL (right drawer for profiles etc) ‚ïê‚ïê */
.pov{position:fixed;inset:0;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s;}
.pov.open{opacity:1;pointer-events:auto;}
.pov-bg{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);}
.panel{position:absolute;top:0;right:0;bottom:0;width:340px;background:var(--bg2);border-left:1px solid var(--brd);transform:translateX(100%);transition:transform .3s var(--ease);display:flex;flex-direction:column;box-shadow:-8px 0 40px rgba(0,0,0,.5);}
@media(max-width:768px){.panel{width:100%;border-left:none;}}
.pov.open .panel{transform:none;}
.ph{padding:14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.ph h3{flex:1;font-size:14.5px;font-weight:700;}
.pb{flex:1;overflow-y:auto;padding:16px;}
/* Profile panel */
.pf-cov{height:80px;background:linear-gradient(135deg,var(--bg3),var(--bg5));border-radius:14px;flex-shrink:0;margin-bottom:-36px;position:relative;overflow:hidden;}
.pf-cov::before{content:'';position:absolute;inset:0;background:var(--accG);opacity:.15;}
.pf-avw{display:flex;justify-content:center;position:relative;z-index:1;margin-bottom:12px;}
.pf-avw .av{border:4px solid var(--bg2);box-shadow:var(--shadow);}
.pf-nm{text-align:center;font-size:19px;font-weight:800;margin-bottom:3px;display:flex;align-items:center;justify-content:center;gap:6px;}
.pf-un{text-align:center;font-size:13px;color:var(--tx2);margin-bottom:8px;}
.pf-creator{background:linear-gradient(135deg,var(--ylw),var(--org));color:#000;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;display:inline-block;margin-bottom:8px;}
.pf-bio{text-align:center;font-size:13px;color:var(--tx2);line-height:1.6;padding:0 8px;margin-bottom:14px;}
.pf-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.stat{background:var(--bg3);border:1px solid var(--brd);border-radius:12px;padding:11px;text-align:center;}
.stat-v{font-size:13px;font-weight:700;}
.stat-l{font-size:10.5px;color:var(--tx3);margin-top:2px;}
.pf-acts{display:flex;gap:8px;margin-bottom:16px;}
.btn-pf{flex:1;padding:10px;border:none;border-radius:11px;font-size:13px;font-weight:700;cursor:pointer;transition:all var(--t);}
.btn-pf.pri{background:var(--accG);color:#fff;box-shadow:0 4px 14px rgba(43,138,245,.3);}
.btn-pf.pri:hover{transform:translateY(-1px);}
.btn-pf.out{background:var(--bg3);border:1px solid var(--brd2);color:var(--tx2);}
.btn-pf.out:hover{border-color:var(--acc);color:var(--acc);}
.btn-pf.danger{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25);color:var(--red);}
.btn-pf.danger:hover{background:rgba(248,113,113,.16);}
/* Chat settings */
.csi{display:flex;align-items:center;gap:11px;padding:12px 13px;border-radius:12px;cursor:pointer;transition:all var(--t);}
.csi:hover{background:var(--bg3);box-shadow:var(--shadow2);}
.csi-ic{font-size:20px;width:26px;text-align:center;flex-shrink:0;}
.csi-t{flex:1;}
.csi-n{font-size:13.5px;font-weight:600;}
.csi-s{font-size:11.5px;color:var(--tx3);}
/* Members */
.mem-item{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:10px;cursor:pointer;transition:all var(--t);}
.mem-item:hover{background:var(--bg3);}
.mem-nm{font-size:13px;font-weight:600;flex:1;display:flex;align-items:center;gap:4px;}
.role-dd{background:var(--bg4);border:1px solid var(--brd2);border-radius:12px;overflow:hidden;margin:4px 0 4px 48px;box-shadow:var(--shadow);}
.role-opt{padding:10px 14px;cursor:pointer;font-size:13px;font-weight:500;transition:background var(--t);}
.role-opt:hover{background:var(--bg5);}
.role-opt.danger{color:var(--red);}
/* Divider */
.divider{height:1px;background:var(--brd);margin:8px 0;}

/* ‚ïê‚ïê MODALS ‚ïê‚ïê */
.mov{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(6px);padding:16px;}
.mov.open{opacity:1;pointer-events:auto;}
.modal{background:var(--bg2);border:1px solid var(--brd2);border-radius:22px;padding:24px;width:100%;max-width:460px;max-height:90vh;display:flex;flex-direction:column;gap:13px;transform:scale(.94);transition:transform .22s var(--ease);box-shadow:0 24px 80px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.05);}
.mov.open .modal{transform:none;}
.mhdr{display:flex;align-items:center;justify-content:space-between;}
.mhdr h3{font-size:15.5px;font-weight:700;}
.mx{background:none;border:none;color:var(--tx3);font-size:22px;cursor:pointer;padding:2px;transition:color var(--t);}
.mx:hover{color:var(--tx);}
.minp{width:100%;background:var(--bg3);border:1.5px solid var(--brd);border-radius:12px;padding:11px 14px;color:var(--tx);font-size:14px;transition:all var(--t);}
.minp:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--accS);}
.minp::placeholder{color:var(--tx3);}
.mta{width:100%;background:var(--bg3);border:1.5px solid var(--brd);border-radius:12px;padding:11px 14px;color:var(--tx);font-size:13.5px;resize:none;height:66px;line-height:1.5;font-family:inherit;transition:all var(--t);}
.mta:focus{border-color:var(--acc);}
.mta::placeholder{color:var(--tx3);}
.mul{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:3px;min-height:60px;max-height:220px;}
.uli{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:11px;cursor:pointer;transition:all var(--t);}
.uli:hover{background:var(--bg3);}
.uli.sel{background:var(--accS);border:1px solid var(--brd2);}
.uli-n{font-size:13px;font-weight:600;display:flex;align-items:center;gap:4px;}
.uli-s{font-size:11.5px;color:var(--tx2);}
.chips{display:flex;flex-wrap:wrap;gap:5px;min-height:20px;}
.chip{display:flex;align-items:center;gap:4px;background:var(--accS);border:1px solid var(--brd2);border-radius:20px;padding:3px 9px;font-size:12px;color:var(--acc);}
.chipx{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:14px;line-height:1;transition:color var(--t);}
.chipx:hover{color:var(--red);}
.mftr{display:flex;gap:8px;margin-top:2px;}
.mc{flex:1;padding:11px;background:var(--bg3);border:1px solid var(--brd);border-radius:11px;color:var(--tx2);font-size:13px;font-weight:600;cursor:pointer;transition:all var(--t);}
.mc:hover{border-color:var(--brd2);color:var(--tx);}
.mo{flex:2;padding:11px;background:var(--accG);border:none;border-radius:11px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all var(--t);box-shadow:0 4px 14px rgba(43,138,245,.3);}
.mo:hover{transform:translateY(-1px);}
.mhint{font-size:11.5px;color:var(--tx3);}
.empty-n{text-align:center;padding:20px;color:var(--tx3);font-size:13px;}
/* Profile edit */
.ef-l{font-size:11.5px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600;}
.ef-i{width:100%;background:var(--bg3);border:1.5px solid var(--brd);border-radius:12px;padding:11px 14px;color:var(--tx);font-size:14px;transition:all var(--t);}
.ef-i:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--accS);}
.ef-i::placeholder{color:var(--tx3);}
.ef-ta{width:100%;background:var(--bg3);border:1.5px solid var(--brd);border-radius:12px;padding:11px 14px;color:var(--tx);font-size:14px;resize:none;height:74px;line-height:1.5;font-family:inherit;transition:all var(--t);}
.ef-ta:focus{border-color:var(--acc);}
.cc{font-size:10.5px;color:var(--tx3);text-align:right;margin-top:2px;}
.colors{display:flex;gap:8px;flex-wrap:wrap;margin-top:5px;}
.csw{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all var(--t);box-shadow:var(--shadow2);}
.csw.act,.csw:hover{border-color:rgba(255,255,255,.7);transform:scale(1.15);}
.ava-up{display:flex;flex-direction:column;align-items:center;gap:10px;padding:16px;background:var(--bg3);border-radius:14px;cursor:pointer;border:2px dashed var(--brd2);transition:all var(--t);}
.ava-up:hover{border-color:var(--acc);background:var(--bg4);}
.ava-up-prev{width:80px;height:80px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden;box-shadow:var(--shadow);}
.ava-up-prev img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
</style>
</head>
<body>

<!-- PARTICLES -->
<div class="particles" id="particles"></div>

<!-- AUTH -->
<div id="auth">
  <div class="auth-bg"></div>
  <div class="auth-orb ao1"></div><div class="auth-orb ao2"></div><div class="auth-orb ao3"></div>
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-logo">
        <div class="auth-logo-icon"><div class="logo-bg"><div class="logo-inner">‚ö°</div></div></div>
        <div class="auth-title">Nexus</div>
        <div class="auth-sub">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</div>
      </div>
      <div class="auth-tabs">
        <button class="at act" id="tab-l" onclick="switchTab('login')">–í–æ–π—Ç–∏</button>
        <button class="at" id="tab-r" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <div class="afields">
        <div id="dn-wrap" class="afield" style="display:none"><span class="afield-ic">üòä</span><input class="ainp ic" type="text" id="a-dn" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" maxlength="32"></div>
        <div class="afield"><span class="afield-pre">@</span><input class="ainp pre" type="text" id="a-un" placeholder="username" autocomplete="username" oninput="cleanUn(this)"></div>
        <div id="un-hint" class="ahint" style="display:none">‚úì –¢–æ–ª—å–∫–æ a-z, 0-9, —Ç–æ—á–∫–∞, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ. –ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤.</div>
        <div class="afield"><span class="afield-ic">üîí</span><input class="ainp ic" type="password" id="a-pw" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)" autocomplete="current-password"></div>
        <div class="aerr hidden" id="a-err">‚ùå <span id="a-err-t"></span></div>
        <button class="abtn" id="a-btn" onclick="doAuth()">–í–æ–π—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- WELCOME SCREEN -->
<div id="welcome-screen" style="display:none">
  <div class="welcome-confetti" id="confetti"></div>
  <div class="welcome-logo">‚ö°</div>
  <div class="welcome-title" id="w-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
  <div class="welcome-sub" id="w-sub">–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ Nexus. –ù–∞–π–¥–∏—Ç–µ –ª—é–¥–µ–π –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <div class="sb" id="sb">
    <div class="sb-head">
      <div class="sb-top">
        <div class="sb-brand"><div class="sb-logo">‚ö°</div><span class="sb-title">Nexus</span></div>
        <button class="ib" title="–ù–∞–ø–∏—Å–∞—Ç—å" onclick="openDMM()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4z"/></svg>
        </button>
        <button class="ib" onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
      <div class="sb-srch">
        <div class="sb-si"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
        <input class="sb-inp" type="search" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤‚Ä¶" oninput="filterChats(this.value)">
      </div>
    </div>
    <div class="chat-list" id="chat-list"></div>
    <div class="sb-foot">
      <div class="ava" onclick="openSettings()" style="cursor:pointer"><div class="av av-md" id="me-av"></div></div>
      <div class="me-inf"><div class="me-name" id="me-name"></div><div class="me-status" id="me-online-status">‚óè –æ–Ω–ª–∞–π–Ω</div></div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="placeholder" id="ph">
      <div class="ph-icon">üí¨</div>
      <div class="ph-t">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
      <div class="ph-s">–∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä</div>
    </div>
    <div id="chat-view" style="display:none;flex-direction:column;flex:1;min-height:0;position:relative;overflow:hidden;">
      <div class="ch">
        <button class="ib ch-back" onclick="goBack()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="m12 5-7 7 7 7"/></svg>
        </button>
        <div class="ava" id="ch-av" onclick="openChatInfo()" style="cursor:pointer"></div>
        <div class="ch-info" onclick="openChatInfo()">
          <div class="ch-name" id="ch-name"></div>
          <div class="ch-sub" id="ch-sub"></div>
        </div>
        <button class="ib" onclick="openChatSettings()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </button>
      </div>
      <div id="pin-bar" class="pin-bar" style="display:none" onclick="scrollToPin()">
        <div class="pin-ic">üìå</div>
        <div class="pin-txt"><span class="pin-lbl" id="pin-lbl">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ</span><span class="pin-val" id="pin-val"></span></div>
        <button class="ib" onclick="event.stopPropagation();unpinMsg()" style="font-size:12px">‚úï</button>
      </div>
      <div class="msgs msgs-bg" id="msgs"></div>
      <div class="typ-wrap" id="typ-wrap" style="display:none">
        <div class="typ-avas" id="typ-avas"></div>
        <div class="typ-right">
          <div class="typ-dots"><span></span><span></span><span></span></div>
          <span class="typ-text" id="typ-text"></span>
        </div>
      </div>
      <div id="emj-picker" class="emj-picker" style="display:none;"></div>
      <div class="input-area">
        <div id="edit-notice" class="edit-notice" style="display:none"><span>‚úèÔ∏è <span id="en-l">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span></span><button class="en-x" onclick="cancelEdit()">‚úï</button></div>
        <div id="pf-bar" class="pf-bar" style="display:none">
          <div class="pf-ico" id="pf-ico">üìé</div>
          <div class="pf-nm" id="pf-nm"></div>
          <div class="pf-sz" id="pf-sz"></div>
          <button class="pf-rm" onclick="rmPF()">‚úï</button>
        </div>
        <div id="ch-notice" class="ch-notice" style="display:none">üì¢ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—É–±–ª–∏–∫—É–µ—Ç</div>
        <div class="irow" id="irow">
          <button class="tb" onclick="toggleEmj()" id="emj-btn">üòä</button>
          <label class="tb" style="cursor:pointer" title="–§–∞–π–ª">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            <input type="file" id="file-inp" style="display:none" onchange="selectFile(this)">
          </label>
          <button class="tb" id="v-btn" onmousedown="startRec(event)" onmouseup="stopRec(event)" ontouchstart="startRec(event)" ontouchend="stopRec(event)" title="–£–¥–µ—Ä–∂–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏">üé§</button>
          <div id="rec-ind" class="rec-ind"><div class="rec-dot"></div><span class="rec-t" id="rec-t">0:00</span><span style="font-size:12px;color:var(--tx2);flex:1">–ó–∞–ø–∏—Å—å‚Ä¶ –æ—Ç–ø—É—Å—Ç–∏</span></div>
          <textarea class="msg-ta" id="msg-ta" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" rows="1" oninput="onTaIn(this)" onkeydown="onTaKey(event)"></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMsg()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS (LEFT PANEL) -->
<div class="settings-ov" id="settings-ov">
  <div class="settings-bg" onclick="closeSettings()"></div>
  <div class="settings-panel">
    <div class="s-top">
      <button class="ib s-close" onclick="closeSettings()">‚úï</button>
      <div class="s-av-wrap" onclick="openPfEdit()">
        <div class="ava"><div class="av av-xl" id="s-av"></div></div>
      </div>
      <div class="s-displayname" id="s-dn"></div>
      <div class="s-username" id="s-un"></div>
      <div class="s-online" id="s-online-txt">‚óè –æ–Ω–ª–∞–π–Ω</div>
    </div>
    <div class="s-body" id="s-body"></div>
  </div>
</div>

<!-- PANEL (right) -->
<div class="pov" id="pov"><div class="pov-bg" onclick="closePov()"></div><div class="panel" id="panel"><div class="ph"><button class="ib" onclick="closePov()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="m12 5-7 7 7 7"/></svg></button><h3 id="p-title">–ü–∞–Ω–µ–ª—å</h3></div><div class="pb" id="p-body"></div></div></div>

<!-- MODALS -->
<div class="mov" id="dm-mov"><div class="modal">
  <div class="mhdr"><h3>üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3><button class="mx" onclick="closeMov('dm-mov')">‚úï</button></div>
  <input class="minp" type="text" id="dm-s" placeholder="–ü–æ–∏—Å–∫‚Ä¶" oninput="fusr(this.value,'dm-ul',startDM)">
  <div class="mul" id="dm-ul"></div>
</div></div>

<div class="mov" id="grp-mov"><div class="modal">
  <div class="mhdr"><h3>üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3><button class="mx" onclick="closeMov('grp-mov')">‚úï</button></div>
  <input class="minp" type="text" id="grp-n" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
  <textarea class="mta" id="grp-d" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
  <div class="chips" id="grp-chips"></div>
  <input class="minp" type="text" id="grp-s" placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤‚Ä¶" oninput="fusr(this.value,'grp-ul',toggleGM)">
  <div class="mul" id="grp-ul"></div>
  <div class="mftr"><button class="mc" onclick="closeMov('grp-mov')">–û—Ç–º–µ–Ω–∞</button><button class="mo" onclick="createGrp()">–°–æ–∑–¥–∞—Ç—å</button></div>
</div></div>

<div class="mov" id="ch-create-mov"><div class="modal">
  <div class="mhdr"><h3>üì¢ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</h3><button class="mx" onclick="closeMov('ch-create-mov')">‚úï</button></div>
  <input class="minp" type="text" id="ch-cn" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
  <div style="position:relative"><span style="position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--tx3);font-weight:700;pointer-events:none;z-index:1">@</span><input class="minp" style="padding-left:30px" type="text" id="ch-cu" placeholder="username –∫–∞–Ω–∞–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" oninput="cleanUn(this)"></div>
  <label class="ava-up" for="ch-ava-inp" id="ch-ava-label">
    <div class="ava-up-prev" id="ch-ava-prev"><span>üì¢</span></div>
    <div style="font-size:12.5px;color:var(--tx2);text-align:center">–ê–≤–∞—Ç–∞—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)<br><span style="font-size:11px;color:var(--tx3)">JPG, PNG</span></div>
    <input type="file" id="ch-ava-inp" accept="image/*" style="display:none" onchange="previewChAva(this)">
  </label>
  <textarea class="mta" id="ch-cd" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ‚Ä¶"></textarea>
  <div class="mhint">Username –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º. –ú–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞.</div>
  <div class="mftr"><button class="mc" onclick="closeMov('ch-create-mov')">–û—Ç–º–µ–Ω–∞</button><button class="mo" onclick="createCh()">–°–æ–∑–¥–∞—Ç—å</button></div>
</div></div>

<div class="mov" id="ch-disc-mov"><div class="modal">
  <div class="mhdr"><h3>üì¢ –ö–∞–Ω–∞–ª—ã</h3><button class="mx" onclick="closeMov('ch-disc-mov')">‚úï</button></div>
  <input class="minp" type="text" id="ch-ds" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤‚Ä¶" oninput="loadChs(this.value)">
  <div class="mul" id="ch-dl"><div class="empty-n">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
  <div class="mftr"><button class="mc" onclick="closeMov('ch-disc-mov')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="mov" id="pf-edit-mov"><div class="modal" style="max-width:500px">
  <div class="mhdr"><h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3><button class="mx" onclick="closeMov('pf-edit-mov')">‚úï</button></div>
  <div id="pf-edit-body" style="overflow-y:auto;max-height:62vh;display:flex;flex-direction:column;gap:13px;padding-right:2px;"></div>
  <div class="mftr"><button class="mc" onclick="closeMov('pf-edit-mov')">–û—Ç–º–µ–Ω–∞</button><button class="mo" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<div class="mov" id="cs-mov"><div class="modal" style="max-width:380px">
  <div class="mhdr"><h3 id="cs-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</h3><button class="mx" onclick="closeMov('cs-mov')">‚úï</button></div>
  <div id="cs-body"></div>
</div></div>

<div class="mov" id="add-acc-mov"><div class="modal" style="max-width:400px">
  <div class="mhdr"><h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h3><button class="mx" onclick="closeMov('add-acc-mov')">‚úï</button></div>
  <div class="afield"><span class="afield-pre">@</span><input class="ainp pre" type="text" id="aa-un" placeholder="username" oninput="cleanUn(this)"></div>
  <div class="afield"><span class="afield-ic">üîí</span><input class="ainp ic" type="password" id="aa-pw" placeholder="–ü–∞—Ä–æ–ª—å"></div>
  <div class="aerr hidden" id="aa-err">‚ùå <span id="aa-err-t"></span></div>
  <div class="mftr"><button class="mc" onclick="closeMov('add-acc-mov')">–û—Ç–º–µ–Ω–∞</button><button class="mo" onclick="addAccount()">–í–æ–π—Ç–∏</button></div>
</div></div>

<script>
/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ TRANSLATIONS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
const LANGS={
  ru:{
    settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',profile:'–ü—Ä–æ—Ñ–∏–ª—å',editProfile:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
    appearance:'–í–Ω–µ—à–Ω–∏–π –≤–∏–¥',theme:'–¢–µ–º–∞',language:'–Ø–∑—ã–∫',
    privacy:'–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å',showOnline:'–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–≤ —Å–µ—Ç–∏"',
    chats:'–ß–∞—Ç—ã',createGroup:'–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É',createChannel:'–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª',
    channels:'–ö–∞–Ω–∞–ª—ã',messaging:'–°–æ–æ–±—â–µ–Ω–∏—è',sendEnter:'Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏',
    notifications:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',accounts:'–ê–∫–∫–∞—É–Ω—Ç—ã',addAccount:'–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç',
    deleteAccount:'–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç',logout:'–í—ã–π—Ç–∏',admin:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
    allUsers:'–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',allChats:'–í—Å–µ —á–∞—Ç—ã',
    online:'–æ–Ω–ª–∞–π–Ω',offline:'–æ—Ñ—Ñ–ª–∞–π–Ω',typing:'–ø–µ—á–∞—Ç–∞–µ—Ç',
    send:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',cancel:'–û—Ç–º–µ–Ω–∞',save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    pinned:'–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ',pinnedMsgs:'–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
    message:'–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶',captionPlaceholder:'–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–∞–π–ª—É‚Ä¶',
    edit:'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',pin:'–ó–∞–∫—Ä–µ–ø–∏—Ç—å',unpin:'–û—Ç–∫—Ä–µ–ø–∏—Ç—å',delete:'–£–¥–∞–ª–∏—Ç—å',
    mute:'–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',unmute:'–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
    block:'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',unblock:'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',deleteChat:'–£–¥–∞–ª–∏—Ç—å —á–∞—Ç',
    adminPanel:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',verified:'–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω',ban:'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
    verify:'–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É',deleteUser:'–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç',
    recently:'–Ω–µ–¥–∞–≤–Ω–æ –≤ —Å–µ—Ç–∏',justNow:'—Ç–æ–ª—å–∫–æ —á—Ç–æ –≤ —Å–µ—Ç–∏',
    recentlyFmt:'–ù–µ–¥–∞–≤–Ω–æ',lastSeenFmt:'–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ',
    subscribers:'–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤',members:'—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤',
    noChats:'–ù–µ—Ç —á–∞—Ç–æ–≤.\n–ù–∞—á–Ω–∏ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä!',
    selectChat:'–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç',startConv:'–∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä',
    welcome:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,',welcomeSub:'–í—ã –≤ Nexus! –ù–∞–π–¥–∏—Ç–µ –ª—é–¥–µ–π –∏ –æ–±—â–∞–π—Ç–µ—Å—å.',
    pinChat:'–ó–∞–∫—Ä–µ–ø–∏—Ç—å —á–∞—Ç',unpinChat:'–û—Ç–∫—Ä–µ–ø–∏—Ç—å —á–∞—Ç',
  },
  en:{
    settings:'Settings',profile:'Profile',editProfile:'Edit Profile',
    appearance:'Appearance',theme:'Theme',language:'Language',
    privacy:'Privacy',showOnline:'Show online status',
    chats:'Chats',createGroup:'Create Group',createChannel:'Create Channel',
    channels:'Channels',messaging:'Messaging',sendEnter:'Enter to send',
    notifications:'Notifications',accounts:'Accounts',addAccount:'Add Account',
    deleteAccount:'Delete Account',logout:'Log out',admin:'Administrator',
    allUsers:'All Users',allChats:'All Chats',
    online:'online',offline:'offline',typing:'is typing',
    send:'Send',cancel:'Cancel',save:'Save',
    pinned:'Pinned',pinnedMsgs:'Pinned Messages',
    message:'Message‚Ä¶',captionPlaceholder:'Add caption to file‚Ä¶',
    edit:'Edit',pin:'Pin',unpin:'Unpin',delete:'Delete',
    mute:'Mute notifications',unmute:'Unmute notifications',
    block:'Block',unblock:'Unblock',deleteChat:'Delete chat',
    adminPanel:'Administrator',verified:'Verified',ban:'Ban',
    verify:'Give badge',deleteUser:'Delete account',
    recently:'recently online',justNow:'just now online',
    recentlyFmt:'Recently',lastSeenFmt:'Last seen recently',
    subscribers:'subscribers',members:'members',
    noChats:'No chats.\nStart a new conversation!',
    selectChat:'Select a chat',startConv:'or start a new conversation',
    welcome:'Welcome,',welcomeSub:'You are in Nexus! Find people and chat.',
    pinChat:'Pin chat',unpinChat:'Unpin chat',
  }
};
let lang=localStorage.getItem('nx-lang')||'ru';
const T=k=>LANGS[lang]?.[k]||LANGS.ru[k]||k;

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ STATE ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
let token=null,me=null;
let ws=null,chats=[],allMsgs={},allUsers=[];
let curChat=null,editMsgId=null,pendingFile=null;
let grpMems=new Map(),typActive={},typTimers={};
let myTypT=null,myTypSent=false,emjOpen=false;
let setts=JSON.parse(localStorage.getItem('nx-s')||'{}');
if(!('sendOnEnter'in setts))setts.sendOnEnter=true;
if(!('notifications'in setts))setts.notifications=true;
if(!('showOnline'in setts))setts.showOnline=true;
if(!('sound'in setts))setts.sound=true;
let mRec=null,aChunks=[],recInt=null,recSec=0;
const aPlayers={};
let chAvaFile=null;
let curTheme=localStorage.getItem('nx-theme')||'blue';
// Multi-account
let accounts=JSON.parse(localStorage.getItem('nx-accounts')||'[]');
const THEMES=['blue','purple','green','red','gold'];
const THEME_COLORS={'blue':'#2b8af5','purple':'#8b5cf6','green':'#10b981','red':'#ef4444','gold':'#f59e0b'};
const EMJS={'üòä':'üòÄüòÅüòÇü§£üòÉüòÑüòÖüòÜüòâüòäüòãüòéüòçü•∞üòòüôÇüòêü§îü§óüòíüòûüòîüò¢üò≠üò§üò†üò°ü§Øüò≥ü•∫üò±üò™üò¥ü•¥ü§ßüò∑ü§ëü§†ü•≥','üëç':'üëçüëéüëå‚úåÔ∏èü§ûüññü§üü§òü§ôüëàüëâüëÜüëá‚úãü§öüñêüëãüí™üôèü´∂üëèü§≤','‚ù§Ô∏è':'‚ù§Ô∏èüß°üíõüíöüíôüíúüñ§ü§çü§éüíî‚ù£Ô∏èüíïüíûüíìüíóüíñüíòüíù','üéâ':'üéâüéäüéàüéÅüéÄüéÇüéÜüéá‚ú®üåü‚≠êüí´üî•üí•üåàüéµüé∂üé∏üé§üéß','üê±':'üê±üê∂üê≠üê∞ü¶äüêªüêºüê®üêØü¶ÅüêÆüê∑üê∏üêµüêîüêßü¶ãüêûüêú','üçï':'üçïüçîüåÆüåØü•ôüç£üçúüçùüç≤ü•òü•öüç≥ü•ûü•ìü•©üçóüçñüå≠üçüüç¶üçßüç©üç™üéÇüç∞üßÅüç´üç¨','‚öΩ':'‚öΩüèÄüèà‚öæüéæüèêüé±üèìüè∏ü•ä‚õ≥üéØüéÆüé≤üÉè','üåç':'üåçüåéüåèüó∫Ô∏èüß≠üåã‚õ∞Ô∏èüèîÔ∏èüèïÔ∏èüèñÔ∏èüèúÔ∏èüèùÔ∏èüèõÔ∏èüè†üè°üè¢üè¶üè®üè™üè´'};
const AVCOLS=['#2b8af5','#7c5ce4','#10b981','#f59e0b','#ef4444','#06b6d4','#ec4899','#14b8a6','#f97316','#84cc16'];

/* Sound */
function playMsgSound(){
  if(!setts.sound)return;
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.type='sine';o.frequency.setValueAtTime(880,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(440,ctx.currentTime+0.1);g.gain.setValueAtTime(.15,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+.15);o.start(ctx.currentTime);o.stop(ctx.currentTime+.15);}catch{}
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ INIT ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function init(){
  setTheme(curTheme);
  createParticles();
  // Load last account
  const savedAccs=JSON.parse(localStorage.getItem('nx-accounts')||'[]');
  if(savedAccs.length){accounts=savedAccs;const last=accounts.find(a=>a.active)||accounts[0];if(last){token=last.token;me=last.user;}}
  if(token&&me){launchApp();}else{document.getElementById('auth').style.display='flex';}
}
function setTheme(t){
  curTheme=t;document.documentElement.setAttribute('data-theme',t);localStorage.setItem('nx-theme',t);
}
function createParticles(){
  const c=document.getElementById('particles');
  for(let i=0;i<12;i++){
    const p=document.createElement('div');p.className='particle';
    const size=2+Math.random()*4;p.style.cssText=`width:${size}px;height:${size}px;background:${THEME_COLORS[curTheme]};left:${Math.random()*100}%;animation-duration:${8+Math.random()*12}s;animation-delay:${Math.random()*8}s;opacity:0;`;
    c.appendChild(p);
  }
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ AUTH ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function cleanUn(el){const s=el.selectionStart;el.value=el.value.toLowerCase().replace(/[^a-z0-9_.]/g,'');el.setSelectionRange(s,s);}
let curTab='login';
function switchTab(t){
  curTab=t;
  document.getElementById('tab-l').classList.toggle('act',t==='login');
  document.getElementById('tab-r').classList.toggle('act',t==='register');
  document.getElementById('a-btn').textContent=t==='login'?'–í–æ–π—Ç–∏':'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  document.getElementById('dn-wrap').style.display=t==='register'?'block':'none';
  document.getElementById('un-hint').style.display=t==='register'?'block':'none';
  showErr('a','');
}
function showErr(prefix,msg){
  const el=document.getElementById(prefix+'-err');const t=document.getElementById(prefix+'-err-t');
  if(!el)return;if(msg){el.classList.remove('hidden');t.textContent=msg;}else{el.classList.add('hidden');}
}
async function doAuth(){
  const un=document.getElementById('a-un').value.trim().replace(/^@/,'');
  const pw=document.getElementById('a-pw').value;
  const dn=document.getElementById('a-dn')?.value.trim();
  showErr('a','');
  if(!un||!pw){showErr('a','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');return;}
  if(curTab==='register'&&un.length<5){showErr('a','Username –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤');return;}
  const ep=curTab==='login'?'/api/login':'/api/register';
  const body=curTab==='login'?{username:un,password:pw}:{username:un,password:pw,displayName:dn||un};
  try{
    const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d=await r.json();
    if(!r.ok){showErr('a',d.error||'–û—à–∏–±–∫–∞');return;}
    token=d.token;me=d.user;
    saveAccount(token,me);
    if(d.isNew)showWelcome(me.displayName||me.username,()=>launchApp());
    else launchApp();
  }catch(e){showErr('a','–û—à–∏–±–∫–∞: '+e.message);}
}
document.getElementById('a-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doAuth();});
document.getElementById('a-un').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('a-pw').focus();});

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ WELCOME ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function showWelcome(name,cb){
  const ws=document.getElementById('welcome-screen');
  ws.style.display='flex';
  document.getElementById('auth').style.display='none';
  document.getElementById('w-title').textContent=T('welcome')+' '+name+'!';
  document.getElementById('w-sub').textContent=T('welcomeSub');
  // Confetti
  const conf=document.getElementById('confetti');
  for(let i=0;i<60;i++){
    const c=document.createElement('div');c.className='conf';
    const col=['#2b8af5','#7c5ce4','#10b981','#f59e0b','#ef4444','#ec4899'][Math.floor(Math.random()*6)];
    c.style.cssText=`left:${Math.random()*100}%;background:${col};animation-duration:${2+Math.random()*2}s;animation-delay:${Math.random()*.8}s;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'3px'};`;
    conf.appendChild(c);
  }
  setTimeout(()=>{ws.style.display='none';conf.innerHTML='';cb();},3000);
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ACCOUNTS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function saveAccount(t,u){
  accounts=accounts.filter(a=>a.user.id!==u.id);
  accounts.forEach(a=>a.active=false);
  accounts.push({token:t,user:u,active:true});
  if(accounts.length>5)accounts.shift();
  localStorage.setItem('nx-accounts',JSON.stringify(accounts));
}
function switchAccount(idx){
  const acc=accounts[idx];if(!acc)return;
  accounts.forEach(a=>a.active=false);accounts[idx].active=true;
  localStorage.setItem('nx-accounts',JSON.stringify(accounts));
  token=acc.token;me=acc.user;
  if(ws)ws.close();
  chats=[];allMsgs={};curChat=null;
  document.getElementById('chat-list').innerHTML='';
  document.getElementById('ph').style.display='flex';
  document.getElementById('chat-view').style.display='none';
  closeSettings();
  renderMeBar();connectWS();loadChats();loadAllUsers();
}
async function addAccount(){
  const un=document.getElementById('aa-un').value.trim().replace(/^@/,'');
  const pw=document.getElementById('aa-pw').value;
  showErr('aa','');
  if(!un||!pw){showErr('aa','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');return;}
  if(accounts.length>=5){showErr('aa','–ú–∞–∫—Å–∏–º—É–º 5 –∞–∫–∫–∞—É–Ω—Ç–æ–≤');return;}
  try{
    const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:un,password:pw})});
    const d=await r.json();
    if(!r.ok){showErr('aa',d.error||'–û—à–∏–±–∫–∞');return;}
    if(accounts.find(a=>a.user.id===d.user.id)){showErr('aa','–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');return;}
    saveAccount(d.token,d.user);closeMov('add-acc-mov');
    // Switch to new account
    token=d.token;me=d.user;
    if(ws)ws.close();chats=[];allMsgs={};curChat=null;
    document.getElementById('ph').style.display='flex';
    document.getElementById('chat-view').style.display='none';
    renderMeBar();connectWS();loadChats();loadAllUsers();
    renderSettingsBody();
  }catch(e){showErr('aa','–û—à–∏–±–∫–∞: '+e.message);}
}
function removeAccount(idx){
  if(accounts.length<=1){alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç');return;}
  const wasActive=accounts[idx]?.active;accounts.splice(idx,1);
  if(wasActive&&accounts.length){accounts[0].active=true;token=accounts[0].token;me=accounts[0].user;if(ws)ws.close();renderMeBar();connectWS();loadChats();loadAllUsers();}
  localStorage.setItem('nx-accounts',JSON.stringify(accounts));
  renderSettingsBody();
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ LAUNCH ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function launchApp(){
  document.getElementById('auth').style.display='none';
  const app=document.getElementById('app');app.style.display='flex';
  setTimeout(()=>app.classList.add('show'),10);
  renderMeBar();connectWS();loadChats();loadAllUsers();
  if(isMobile())showSB();
}
function renderMeBar(){
  renderAv(document.getElementById('me-av'),me,'md');
  const mn=document.getElementById('me-name');
  mn.innerHTML=esc(me.displayName||me.username)+(me.verified?'<span class="verified-inline">‚úì</span>':'')+(me.isCreator?'<span class="creator-badge">‚ö° Creator</span>':'');
  document.getElementById('me-online-status').textContent=setts.showOnline?'‚óè '+T('online'):'‚óé –Ω–µ–≤–∏–¥–∏–º—ã–π';
  // Settings sidebar header
  renderAv(document.getElementById('s-av'),me,'xl');
  const sdn=document.getElementById('s-dn');
  if(sdn)sdn.innerHTML=esc(me.displayName||me.username)+(me.verified?'<span class="verified-inline">‚úì</span>':'')+(me.isCreator?'<span class="creator-badge">‚ö° Creator</span>':'');
  const sun=document.getElementById('s-un');
  if(sun)sun.innerHTML='@'+esc(me.username);
  const sonl=document.getElementById('s-online-txt');
  if(sonl)sonl.textContent=setts.showOnline?('‚óè '+T('online')):'‚óé –Ω–µ–≤–∏–¥–∏–º—ã–π';
}
function logout(){
  accounts=accounts.filter(a=>a.user.id!==me.id);
  localStorage.setItem('nx-accounts',JSON.stringify(accounts));
  if(accounts.length){const next=accounts[0];next.active=true;token=next.token;me=next.user;localStorage.setItem('nx-accounts',JSON.stringify(accounts));if(ws)ws.close();chats=[];allMsgs={};curChat=null;renderMeBar();connectWS();loadChats();loadAllUsers();closeSettings();return;}
  localStorage.removeItem('nx-accounts');if(ws)ws.close();location.reload();
}
async function deleteMyAccount(){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'))return;
  await api('/api/me/delete','POST',{});
  accounts=accounts.filter(a=>a.user.id!==me.id);localStorage.setItem('nx-accounts',JSON.stringify(accounts));
  if(accounts.length){const next=accounts[0];next.active=true;token=next.token;me=next.user;localStorage.setItem('nx-accounts',JSON.stringify(accounts));if(ws)ws.close();chats=[];allMsgs={};renderMeBar();connectWS();loadChats();loadAllUsers();closeSettings();}
  else{localStorage.removeItem('nx-accounts');if(ws)ws.close();location.reload();}
}
function isMobile(){return window.innerWidth<=768;}
function showSB(){document.getElementById('sb').classList.add('open');}
function hideSB(){document.getElementById('sb').classList.remove('open');}
function goBack(){hideSB();showSB();}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ WS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function connectWS(){
  const pr=location.protocol==='https:'?'wss':'ws';
  ws=new WebSocket(`${pr}://${location.host}?token=${token}`);
  ws.onclose=()=>setTimeout(()=>{if(token)connectWS();},3000);
  ws.onmessage=e=>{try{handleWS(JSON.parse(e.data));}catch(x){console.error(x);}};
}
function wsSend(d){if(ws&&ws.readyState===1)ws.send(JSON.stringify(d));}
function handleWS(m){
  switch(m.type){
    case 'new_message': onNewMsg(m.message);break;
    case 'message_edited': onMsgEdited(m.message);break;
    case 'message_deleted': onMsgDel(m.chatId,m.messageId);break;
    case 'typing': onTyping(m);break;
    case 'presence': onPresence(m);break;
    case 'messages_read': onMsgsRead(m);break;
    case 'chat_created': upsertChat(m.chat);renderChatList();break;
    case 'chat_updated': onChatUpd(m.chat);break;
    case 'chat_deleted': onChatDel(m.chatId);break;
    case 'user_updated': onUserUpd(m.user);break;
    case 'message_pinned': onMsgPinned(m);break;
  }
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CHATS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
async function loadChats(){const r=await api('/api/chats');if(r.ok){chats=await r.json();renderChatList();}}
async function loadAllUsers(){const r=await api('/api/users');if(r.ok)allUsers=await r.json();}
function upsertChat(c){const i=chats.findIndex(x=>x.id===c.id);if(i!==-1)chats[i]=c;else chats.unshift(c);}
function renderChatList(list){
  list=list||chats;
  const el=document.getElementById('chat-list');
  if(!list.length){el.innerHTML=`<div class="empty-sb">${esc(T('noChats'))}</div>`;return;}
  const pins=list.filter(c=>c.isPinnedByUser);
  const rest=list.filter(c=>!c.isPinnedByUser);
  const dms=rest.filter(c=>c.type==='dm');
  const grps=rest.filter(c=>c.type==='group');
  const chs=rest.filter(c=>c.type==='channel');
  let h='';
  if(pins.length)h+='<div class="sec-l">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ</div>'+pins.map(ciH).join('');
  if(dms.length)h+=dms.map(ciH).join('');
  if(grps.length)h+='<div class="sec-l">üë• '+T('chats')+'</div>'+grps.map(ciH).join('');
  if(chs.length)h+='<div class="sec-l">üì¢ –ö–∞–Ω–∞–ª—ã</div>'+chs.map(ciH).join('');
  el.innerHTML=h;
}
function ciH(c){
  const act=c.id===curChat;
  const last=c.lastMessage;
  let prev=T('noChats').split('\n')[0]||'';
  if(last){const mine=last.senderId===me.id;const pre=c.type!=='dm'&&!mine?(last.senderName+': '):(mine?'–í—ã: ':'');
  prev=last.type==='voice'?pre+'üé§':last.type==='file'?pre+'üìé '+(last.text||''):pre+(last.text||'');}
  const od=c.type==='dm'&&c.online?'<div class="on-dot md"></div>':'';
  const vb=c.verified?'<span class="verified-inline">‚úì</span>':'';
  const ic=c.type==='channel'?'üì¢ ':c.type==='group'?'üë• ':'';
  const pinIc=c.isPinnedByUser?'<span class="ci-pin">üìå</span>':'';
  return`<div class="ci ${act?'act':''}" onclick="openChat('${c.id}')" oncontextmenu="ctxChat(event,'${c.id}')">
    <div class="ava">${avH(c,'md')}${od}</div>
    <div class="ci-info">${pinIc}
      <div class="ci-top"><div class="ci-name">${ic}${esc(c.name)}${vb}</div><div class="ci-time">${last?fmtT(last.createdAt):''}</div></div>
      <div class="ci-bot"><div class="ci-prev">${esc(prev)}</div>${c.muted?'<span class="ci-muted">üîï</span>':''}${c.unreadCount>0?`<div class="ci-badge">${c.unreadCount}</div>`:''}</div>
    </div></div>`;
}
function filterChats(q){if(!q.trim()){renderChatList();return;}renderChatList(chats.filter(c=>c.name?.toLowerCase().includes(q.toLowerCase())));}

/* Right click on chat item */
function ctxChat(e,chatId){
  e.preventDefault();
  const chat=chats.find(c=>c.id===chatId);if(!chat)return;
  const isPinned=chat.isPinnedByUser;
  const label=isPinned?T('unpinChat'):T('pinChat');
  if(confirm(label+'?'))togglePinChat(chatId,isPinned);
}
async function togglePinChat(chatId,isPinned){
  await api(`/api/chats/${chatId}/pin-chat`,'POST',{});
  await loadChats();
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ OPEN CHAT ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
async function openChat(id){
  curChat=id;editMsgId=null;pendingFile=null;
  if(emjOpen)closeEmj();
  document.getElementById('edit-notice').style.display='none';
  document.getElementById('pf-bar').style.display='none';
  document.getElementById('msg-ta').value='';
  document.getElementById('msg-ta').placeholder=T('message');
  const chat=chats.find(c=>c.id===id);if(!chat)return;
  renderChatList();
  if(isMobile())hideSB();
  document.getElementById('ph').style.display='none';
  const view=document.getElementById('chat-view');view.style.display='flex';
  updChatHeader(chat);
  const canPost=canPostInChat(chat);
  document.getElementById('irow').style.display=canPost?'flex':'none';
  document.getElementById('ch-notice').style.display=canPost?'none':'block';
  await loadMsgs(id);
  wsSend({type:'mark_read',chatId:id});
  chat.unreadCount=0;renderChatList();
  if(canPost)document.getElementById('msg-ta').focus();
  updPinBar(chat);
}
function canPostInChat(chat){
  if(chat.type==='channel')return chat.ownerId===me.id||(chat.roles&&chat.roles[me.id]==='admin');
  return true;
}
function updChatHeader(chat){
  const av=document.getElementById('ch-av');
  av.innerHTML=avH(chat,'md')+(chat.type==='dm'&&chat.online?'<div class="on-dot md"></div>':'');
  const vb=chat.verified?'<span class="verified-inline">‚úì</span>':'';
  document.getElementById('ch-name').innerHTML=esc(chat.name)+vb+(chat.type==='channel'?'<span class="ch-tag ch">üì¢</span>':chat.type==='group'?'<span class="ch-tag gr">üë•</span>':'');
  const sub=document.getElementById('ch-sub');
  if(chat.type==='dm'){
    const other=chat.members?.find(m=>m.id!==me.id);
    if(chat.online)sub.textContent='‚óè '+T('online');
    else if(other?.hiddenLastSeen||!other?.showOnline)sub.textContent=T('lastSeenFmt');
    else sub.textContent=T('offline');
  }
  else if(chat.type==='channel')sub.textContent=`${chat.subscribersCount||chat.members?.length||0} ${T('subscribers')}`;
  else sub.textContent=`${chat.members?.length||0} ${T('members')}`;
}
function updPinBar(chat){
  const bar=document.getElementById('pin-bar');
  if(!chat||!chat.pinnedMessageId){bar.style.display='none';return;}
  const msgs=allMsgs[chat.id]||[];const pm=msgs.find(m=>m.id===chat.pinnedMessageId);
  if(!pm){bar.style.display='none';return;}
  bar.style.display='flex';
  document.getElementById('pin-lbl').textContent=T('pinned');
  document.getElementById('pin-val').textContent=pm.type==='voice'?'üé§':pm.type==='file'?'üìé '+pm.fileName:pm.text;
}
async function loadMsgs(chatId){
  const r=await api(`/api/chats/${chatId}/messages?limit=60`);if(!r.ok)return;
  allMsgs[chatId]=await r.json();renderMsgs(chatId);
}
function scrollToPin(){
  const chat=chats.find(c=>c.id===curChat);if(!chat||!chat.pinnedMessageId)return;
  // Show all pinned messages
  const msgs=allMsgs[chat.id]||[];
  const pinned=msgs.filter(m=>m.pinned);
  if(pinned.length>1){openPinnedList(pinned);return;}
  const el=document.getElementById('m-'+chat.pinnedMessageId);
  if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.querySelector('.mbub').style.boxShadow='0 0 0 2px var(--acc)';setTimeout(()=>{const b=el.querySelector('.mbub');if(b)b.style.boxShadow='';},1500);}
}
function openPinnedList(pinned){
  const html=pinned.map(m=>`<div style="padding:10px;background:var(--bg3);border-radius:10px;margin-bottom:6px;cursor:pointer;border:1px solid var(--brd)" onclick="closePov();const el=document.getElementById('m-${m.id}');if(el)el.scrollIntoView({behavior:'smooth',block:'center'});">
    <div style="font-size:11px;color:var(--acc);font-weight:700;margin-bottom:3px">üìå ${esc(m.senderName)}</div>
    <div style="font-size:13px;color:var(--tx2)">${m.type==='voice'?'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ':m.type==='file'?'üìé '+esc(m.fileName||''):esc(m.text.slice(0,80))}</div>
  </div>`).join('');
  document.getElementById('p-body').innerHTML=html;
  document.getElementById('p-title').textContent=T('pinnedMsgs');
  openPov();
}
async function unpinMsg(){
  if(!curChat)return;const chat=chats.find(c=>c.id===curChat);if(!chat||!chat.pinnedMessageId)return;
  await api(`/api/chats/${curChat}/pin/${chat.pinnedMessageId}`,'POST',{});
}
async function togglePin(chatId,msgId){await api(`/api/chats/${chatId}/pin/${msgId}`,'POST',{});}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ RENDER MESSAGES ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function renderMsgs(chatId){
  if(chatId!==curChat)return;
  const msgs=allMsgs[chatId]||[];
  const el=document.getElementById('msgs');
  const chat=chats.find(c=>c.id===chatId);
  const isGrp=chat?.type==='group'||chat?.type==='channel';
  if(!msgs.length){el.innerHTML='<div class="empty-n" style="margin:auto">üëã</div>';return;}
  let h='',lastDate=null;
  for(const msg of msgs){
    const d=new Date(msg.createdAt).toLocaleDateString(lang==='en'?'en-US':'ru-RU',{day:'numeric',month:'long'});
    if(d!==lastDate){h+=`<div class="date-sep">${d}</div>`;lastDate=d;}
    const isOut=msg.senderId===me.id;
    const isRead=isOut&&(msg.readBy?.length||1)>1;
    const col=msg.senderAvatarColor||'#2b8af5';
    const role=chat?.roles?.[msg.senderId];
    const isOwner=msg.senderId===chat?.ownerId;
    const roleBadge=isOwner?'<span class="m-rbadge owner">'+esc(lang==='en'?'Owner':'–í–ª–∞–¥–µ–ª–µ—Ü')+'</span>':role==='admin'?'<span class="m-rbadge admin">'+esc(lang==='en'?'Admin':'–ê–¥–º–∏–Ω')+'</span>':role==='mod'?'<span class="m-rbadge mod">'+esc(lang==='en'?'Mod':'–ú–æ–¥.')+'</span>':'';
    const verB=msg.senderVerified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':'';
    const crB=msg.senderIsCreator?'<span class="creator-badge" style="font-size:8px;padding:1px 4px">‚ö°</span>':'';
    let content='';
    if(msg.type==='voice'&&msg.fileUrl){
      const wf=msg.waveform||genWave(32);
      const dur=msg.duration?fmtDur(msg.duration):'0:00';
      content=`<div class="m-voice">
        <button class="vplay" id="vbtn-${msg.id}" onclick="playV('${msg.id}',this)">‚ñ∂</button>
        <div class="vcenter">
          <div class="waveform" id="wf-${msg.id}" data-url="${esc(msg.fileUrl)}" data-id="${msg.id}" onclick="seekV(event,this,'${msg.id}')">
            ${wf.map((v,i)=>`<div class="wb" id="wb-${msg.id}-${i}" style="height:${Math.max(4,Math.round(v*30))}px"></div>`).join('')}
          </div>
          <div class="v-bot"><span class="v-dur" id="vdur-${msg.id}">${dur}</span></div>
        </div>
      </div>`;
    }else if(msg.type==='file'&&msg.fileUrl){
      const isImg=msg.fileMime?.startsWith('image/');
      if(isImg){
        content=`<div><img src="${esc(msg.fileUrl)}" loading="lazy" style="max-width:240px;max-height:240px;border-radius:13px;display:block;cursor:pointer;object-fit:cover;box-shadow:var(--shadow2)" onclick="window.open('${esc(msg.fileUrl)}','_blank')"></div>`;
        if(msg.caption)content+=`<span class="m-caption">${esc(msg.caption)}</span>`;
      }else{
        content=`<div class="m-file"><div class="mf-ic">${fic(msg.fileMime||'')}</div><div class="mf-info"><div class="mf-name">${esc(msg.fileName||'File')}</div><div class="mf-size">${fsz(msg.fileSize||0)}</div></div><a href="${esc(msg.fileUrl)}" download="${esc(msg.fileName||'file')}" class="mf-dl">‚¨á</a></div>`;
        if(msg.caption)content+=`<span class="m-caption">${esc(msg.caption)}</span>`;
      }
    }else{content=`<span class="m-text">${esc(msg.text)}</span>`;}
    const canEdit=isOut&&msg.type==='text';
    const acts=`<div class="macts">
      ${canEdit?`<button class="mab" onclick="startEdit('${msg.id}',\`${msg.text.replace(/`/g,'\\`').replace(/\n/g,'\\n')}\`)">‚úèÔ∏è</button>`:''}
      <button class="mab" onclick="togglePin('${chatId}','${msg.id}')">üìå</button>
      ${isOut?`<button class="mab del" onclick="delMsg('${msg.id}')">üóë</button>`:''}
    </div>`;
    const ticks=isOut?`<span class="m-ticks">${ticksSvg(isRead)}</span>`:'';
    const pinIc=msg.pinned?`<span class="m-pin-ic">üìå</span>`:'';
    h+=`<div class="mr ${isOut?'out':'in'}" id="m-${msg.id}">
      ${!isOut?`<div class="mava"><div class="ava"><div class="av av-sm" style="background:${col}">${msg.senderAvatar?`<img src="${esc(msg.senderAvatar)}">`:(msg.senderName||'?')[0].toUpperCase()}</div></div></div>`:''}
      <div class="mbub" tabindex="0">
        ${acts}
        ${isGrp&&!isOut?`<div class="m-sender" style="color:${col}">${esc(msg.senderName)}${verB}${crB}${roleBadge}</div>`:''}
        ${content}
        <div class="m-meta">${pinIc}${msg.edited?`<span class="m-edited">${lang==='en'?'edited':'–∏–∑–º.'}</span>`:''}<span class="m-time">${fmtT(msg.createdAt)}</span>${ticks}</div>
      </div></div>`;
  }
  el.innerHTML=h;el.scrollTop=el.scrollHeight;
}
function ticksSvg(read){
  const c=read?'var(--acc)':'var(--tx3)';
  // Beautiful double tick - properly spaced
  return read
    ?`<svg class="tick-svg" width="20" height="12" viewBox="0 0 20 12" fill="none">
        <path d="M1 6L5.5 11L15.5 1" stroke="${c}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 6L9.5 11L19.5 1" stroke="${c}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" opacity="0.6"/>
      </svg>`
    :`<svg class="tick-svg" width="14" height="12" viewBox="0 0 14 12" fill="none">
        <path d="M1 6L5.5 11L13 1" stroke="${c}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ SEND ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function sendMsg(){
  const ta=document.getElementById('msg-ta');const text=ta.value.trim();
  if(!curChat)return;
  if(pendingFile){
    wsSend({type:'send_message',chatId:curChat,text:pendingFile.name,caption:text,msgType:'file',fileUrl:pendingFile.url,fileName:pendingFile.name,fileSize:pendingFile.size,fileMime:pendingFile.mime});
    rmPF();ta.value='';ta.style.height='';stopTyp();playMsgSound();return;
  }
  if(!text)return;
  if(editMsgId){wsSend({type:'edit_message',chatId:curChat,messageId:editMsgId,text});cancelEdit();}
  else{wsSend({type:'send_message',chatId:curChat,text,msgType:'text'});playMsgSound();}
  ta.value='';ta.style.height='';stopTyp();
}
function startEdit(id,t){editMsgId=id;const ta=document.getElementById('msg-ta');ta.value=t;document.getElementById('edit-notice').style.display='flex';ta.focus();rszTa(ta);}
function cancelEdit(){editMsgId=null;document.getElementById('msg-ta').value='';document.getElementById('edit-notice').style.display='none';}
function delMsg(id){if(curChat)wsSend({type:'delete_message',chatId:curChat,messageId:id});}

/* FILE */
function selectFile(inp){
  if(!inp.files[0]||!curChat)return;
  const file=inp.files[0];const fd=new FormData();fd.append('file',file,file.name);
  fetch('/api/upload',{method:'POST',headers:{Authorization:`Bearer ${token}`},body:fd})
    .then(r=>r.json()).then(d=>{
      pendingFile={url:d.url,name:d.name,size:d.size,mime:d.mime};
      document.getElementById('pf-ico').textContent=fic(d.mime||'');
      document.getElementById('pf-nm').textContent=d.name;
      document.getElementById('pf-sz').textContent=fsz(d.size);
      document.getElementById('pf-bar').style.display='flex';
      document.getElementById('msg-ta').placeholder=T('captionPlaceholder');
      document.getElementById('msg-ta').focus();
    }).catch(e=>alert('Upload error: '+e.message));
  inp.value='';
}
function rmPF(){pendingFile=null;document.getElementById('pf-bar').style.display='none';document.getElementById('msg-ta').placeholder=T('message');}

/* VOICE */
async function startRec(e){
  if(e.type.startsWith('touch'))e.preventDefault();
  if(!curChat)return;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    aChunks=[];recSec=0;
    // Try webm first, fallback to ogg
    const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg';
    mRec=new MediaRecorder(stream,{mimeType});
    mRec.ondataavailable=ev=>{if(ev.data.size>0)aChunks.push(ev.data);};
    mRec.start(100);
    document.getElementById('rec-ind').style.display='flex';
    document.getElementById('msg-ta').style.display='none';
    document.getElementById('v-btn').classList.add('recording');
    recInt=setInterval(()=>{recSec++;const m=Math.floor(recSec/60),s=recSec%60;document.getElementById('rec-t').textContent=`${m}:${s.toString().padStart(2,'0')}`;},1000);
  }catch{alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');}
}
async function stopRec(e){
  if(e.type.startsWith('touch'))e.preventDefault();
  if(!mRec||mRec.state==='inactive')return;
  clearInterval(recInt);
  document.getElementById('rec-ind').style.display='none';
  document.getElementById('msg-ta').style.display='';
  document.getElementById('v-btn').classList.remove('recording');
  if(recSec<1){if(mRec.state!=='inactive')mRec.stop();mRec.stream?.getTracks().forEach(t=>t.stop());mRec=null;return;}
  const dur=recSec;const wf=genWave(32);
  await new Promise(r=>{mRec.onstop=r;if(mRec.state!=='inactive')mRec.stop();});
  mRec.stream?.getTracks().forEach(t=>t.stop());
  const mimeType=mRec.mimeType||'audio/webm';mRec=null;
  const blob=new Blob(aChunks,{type:mimeType});
  const ext=mimeType.includes('ogg')?'.ogg':'.webm';
  const fd=new FormData();fd.append('file',blob,`voice_${Date.now()}${ext}`);
  try{
    const r=await fetch('/api/upload',{method:'POST',headers:{Authorization:`Bearer ${token}`},body:fd});
    if(!r.ok)return;const d=await r.json();
    wsSend({type:'send_message',chatId:curChat,text:'üé§',msgType:'voice',fileUrl:d.url,fileMime:mimeType,waveform:wf,duration:dur});
    playMsgSound();
  }catch(ex){console.error(ex);}
}

/* VOICE PLAYBACK */
function playV(msgId,btn){
  const wfEl=document.getElementById('wf-'+msgId);
  const url=wfEl?.dataset.url;if(!url)return;
  // Stop others
  for(const[id,a]of Object.entries(aPlayers)){
    if(id!==msgId&&!a.paused){a.pause();const b=document.getElementById('vbtn-'+id);if(b)b.innerHTML='‚ñ∂';}
  }
  if(aPlayers[msgId]){
    const a=aPlayers[msgId];
    if(a.paused){a.play().then(()=>btn.innerHTML='‚è∏').catch(console.error);}
    else{a.pause();btn.innerHTML='‚ñ∂';}
    return;
  }
  const a=new Audio();
  // Force correct MIME type for webm audio
  a.src=url;
  aPlayers[msgId]=a;
  a.onloadedmetadata=()=>{const d=document.getElementById('vdur-'+msgId);if(d&&a.duration&&isFinite(a.duration))d.textContent=fmtDur(Math.floor(a.duration));};
  a.ontimeupdate=()=>{
    if(!a.duration||!isFinite(a.duration))return;
    const pct=a.currentTime/a.duration;
    const wf2=document.getElementById('wf-'+msgId);if(!wf2)return;
    const bars=wf2.querySelectorAll('.wb');const played=Math.floor(pct*bars.length);
    bars.forEach((b,i)=>b.classList.toggle('p',i<played));
    const d=document.getElementById('vdur-'+msgId);if(d)d.textContent=fmtDur(Math.floor(a.currentTime));
  };
  a.onended=()=>{btn.innerHTML='‚ñ∂';const wf2=document.getElementById('wf-'+msgId);if(wf2)wf2.querySelectorAll('.wb').forEach(b=>b.classList.remove('p'));};
  a.onerror=()=>{console.error('Audio error for',url,a.error);btn.innerHTML='‚ñ∂';};
  a.play().then(()=>btn.innerHTML='‚è∏').catch(err=>{console.error('Play failed:',err);btn.innerHTML='‚ñ∂';});
}
function seekV(e,wfEl,msgId){
  const rect=wfEl.getBoundingClientRect();const pct=(e.clientX-rect.left)/rect.width;
  const btn=document.getElementById('vbtn-'+msgId);
  if(!aPlayers[msgId]){playV(msgId,btn);return;}
  const a=aPlayers[msgId];if(a.duration&&isFinite(a.duration)){a.currentTime=pct*a.duration;}
}
function genWave(n){return Array.from({length:n},()=>0.15+Math.random()*0.85);}

/* EMOJI */
let emjCat=Object.keys(EMJS)[0];
function toggleEmj(){
  emjOpen=!emjOpen;
  const el=document.getElementById('emj-picker');
  if(!emjOpen){el.style.display='none';return;}
  renderEmj();el.style.display='block';
}
function closeEmj(){emjOpen=false;document.getElementById('emj-picker').style.display='none';}
function renderEmj(cat){
  cat=cat||emjCat;emjCat=cat;
  const cats=Object.keys(EMJS);
  const emojis=[...EMJS[cat]].filter(c=>c.codePointAt(0)>127);
  const el=document.getElementById('emj-picker');
  el.innerHTML=`<div class="emj-tabs">${cats.map(c=>`<button class="emj-tab ${c===cat?'act':''}" onclick="event.stopPropagation();renderEmj('${c}')">${c}</button>`).join('')}</div>
    <div class="emj-grid">${emojis.map(e=>`<button class="emj-btn" onclick="event.stopPropagation();insEmj('${e}')">${e}</button>`).join('')}</div>`;
}
function insEmj(e){
  const ta=document.getElementById('msg-ta');
  const s=ta.selectionStart,end=ta.selectionEnd;
  ta.value=ta.value.slice(0,s)+e+ta.value.slice(end);
  ta.selectionStart=ta.selectionEnd=s+[...e].length;
  ta.focus();rszTa(ta);
  // DON'T close picker - allow multiple emoji
}
// Only close on outside click (not on picker elements)
document.addEventListener('click',e=>{
  if(emjOpen&&!e.target.closest('#emj-picker')&&!e.target.closest('#emj-btn'))closeEmj();
});

/* TYPING */
function onTaIn(el){rszTa(el);if(!curChat)return;if(!myTypSent){wsSend({type:'typing',chatId:curChat,isTyping:true});myTypSent=true;}clearTimeout(myTypT);myTypT=setTimeout(stopTyp,2000);}
function stopTyp(){if(myTypSent&&curChat){wsSend({type:'typing',chatId:curChat,isTyping:false});myTypSent=false;}}
function onTaKey(e){if(e.key==='Enter'){if(setts.sendOnEnter&&!e.shiftKey){e.preventDefault();sendMsg();}else if(!setts.sendOnEnter&&(e.ctrlKey||e.metaKey)){e.preventDefault();sendMsg();}}}
function rszTa(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ WS HANDLERS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function onNewMsg(msg){
  const chat=chats.find(c=>c.id===msg.chatId);
  if(chat){chat.lastMessage={id:msg.id,text:msg.text||'',type:msg.type,caption:msg.caption||'',senderId:msg.senderId,senderName:msg.senderName,createdAt:msg.createdAt};
    if(msg.chatId!==curChat)chat.unreadCount=(chat.unreadCount||0)+1;
    chats.sort((a,b)=>{const ap=a.isPinnedByUser?1:0,bp=b.isPinnedByUser?1:0;if(bp!==ap)return bp-ap;return(b.lastMessage?.createdAt||b.createdAt)-(a.lastMessage?.createdAt||a.createdAt);});
    renderChatList();}
  if(msg.chatId===curChat){if(!allMsgs[curChat])allMsgs[curChat]=[];allMsgs[curChat].push(msg);renderMsgs(curChat);wsSend({type:'mark_read',chatId:curChat});}
  else if(setts.notifications&&msg.senderId!==me.id){try{if(Notification.permission==='granted')new Notification((msg.senderName||'')+'',{body:msg.text||'üìé',icon:'/favicon.ico'});}catch{}}
}
function onMsgEdited(msg){if(!allMsgs[msg.chatId])return;const i=allMsgs[msg.chatId].findIndex(m=>m.id===msg.id);if(i!==-1)allMsgs[msg.chatId][i]=msg;if(msg.chatId===curChat)renderMsgs(curChat);}
function onMsgDel(chatId,msgId){if(allMsgs[chatId])allMsgs[chatId]=allMsgs[chatId].filter(m=>m.id!==msgId);if(chatId===curChat)renderMsgs(curChat);}
function onTyping({chatId,userId,displayName,isTyping,avatar,avatarColor}){
  if(chatId!==curChat||userId===me.id)return;
  if(isTyping){typActive[userId]={name:displayName,avatar,avatarColor};clearTimeout(typTimers[userId]);typTimers[userId]=setTimeout(()=>{delete typActive[userId];updTyp();},3500);}
  else{delete typActive[userId];clearTimeout(typTimers[userId]);}updTyp();
}
function updTyp(){
  const users=Object.values(typActive);const wrap=document.getElementById('typ-wrap');
  if(!users.length){wrap.style.display='none';return;}
  wrap.style.display='flex';
  document.getElementById('typ-avas').innerHTML=users.slice(0,3).map(u=>`<div class="av av-xs" style="background:${u.avatarColor||'#2b8af5'}">${u.avatar?`<img src="${u.avatar}">`:(u.name||'?')[0].toUpperCase()}</div>`).join('');
  const names=users.map(u=>u.name);
  document.getElementById('typ-text').textContent=names.length===1?names[0]+' '+T('typing')+'‚Ä¶':names.join(', ')+' '+T('typing')+'‚Ä¶';
}
function onPresence({userId,online,showOnline,lastSeen}){
  if(!showOnline)return; // Don't show status if user hides it
  allUsers=allUsers.map(u=>u.id===userId?{...u,online,hiddenLastSeen:lastSeen}:u);
  chats.forEach(c=>{if(c.type==='dm'&&c.members?.some(m=>m.id===userId&&m.id!==me.id)){c.online=online&&showOnline;}if(c.members)c.members=c.members.map(m=>m.id===userId?{...m,online}:m);});
  renderChatList();
  if(curChat){const chat=chats.find(c=>c.id===curChat);if(chat?.type==='dm'&&chat.members?.some(m=>m.id===userId&&m.id!==me.id))updChatHeader(chat);}
}
function onMsgsRead({chatId,userId}){
  if(userId===me.id||!allMsgs[chatId])return;
  allMsgs[chatId].forEach(m=>{if(Array.isArray(m.readBy)&&!m.readBy.includes(userId))m.readBy.push(userId);});
  if(chatId===curChat)renderMsgs(chatId);
}
function onChatUpd(chat){upsertChat(chat);renderChatList();if(chat.id===curChat){updChatHeader(chat);updPinBar(chat);}}
function onChatDel(chatId){chats=chats.filter(c=>c.id!==chatId);renderChatList();if(chatId===curChat){curChat=null;document.getElementById('ph').style.display='flex';document.getElementById('chat-view').style.display='none';if(isMobile())showSB();}}
function onUserUpd(user){
  if(user.id===me.id){me={...me,...user};const acc=accounts.find(a=>a.user.id===me.id);if(acc){acc.user=me;localStorage.setItem('nx-accounts',JSON.stringify(accounts));}renderMeBar();}
  allUsers=allUsers.map(u=>u.id===user.id?{...u,...user}:u);
  chats.forEach(c=>{if(c.members)c.members=c.members.map(m=>m.id===user.id?{...m,...user}:m);if(c.type==='dm'){const o=c.members?.find(m=>m.id===user.id&&m.id!==me.id);if(o){c.name=o.displayName||o.username;c.avatar=o.avatar;c.avatarColor=o.avatarColor;}}});
  renderChatList();
}
function onMsgPinned({chatId,messageId,message}){
  const chat=chats.find(c=>c.id===chatId);if(!chat)return;
  chat.pinnedMessageId=messageId;
  if(allMsgs[chatId]){allMsgs[chatId].forEach(m=>{m.pinned=m.id===messageId||m.pinned&&m.id!==messageId;});}
  if(chatId===curChat){renderMsgs(chatId);updPinBar(chat);}
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ DM / GROUP / CHANNEL ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function openDMM(){openMov('dm-mov');document.getElementById('dm-s').value='';fusr('','dm-ul',startDM);}
async function startDM(user){closeMov('dm-mov');const r=await api('/api/chats/dm','POST',{userId:user.id});if(!r.ok){const e=await r.json();alert(e.error);return;}const chat=await r.json();upsertChat(chat);renderChatList();openChat(chat.id);}

function openGrpM(){grpMems.clear();document.getElementById('grp-n').value='';document.getElementById('grp-d').value='';document.getElementById('grp-chips').innerHTML='';openMov('grp-mov');fusr('','grp-ul',toggleGM);}
function toggleGM(user){if(grpMems.has(user.id))grpMems.delete(user.id);else grpMems.set(user.id,user);renderGrpChips();fusr(document.getElementById('grp-s').value,'grp-ul',toggleGM);}
function renderGrpChips(){document.getElementById('grp-chips').innerHTML=[...grpMems.values()].map(u=>`<div class="chip">${esc(u.displayName||u.username)}<button class="chipx" onclick="grpMems.delete('${u.id}');renderGrpChips()">√ó</button></div>`).join('');}
async function createGrp(){
  const name=document.getElementById('grp-n').value.trim();const desc=document.getElementById('grp-d').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}if(!grpMems.size){alert('–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');return;}
  const r=await api('/api/chats/group','POST',{name,description:desc,memberIds:[...grpMems.keys()]});
  if(!r.ok){const e=await r.json();alert(e.error);return;}
  const chat=await r.json();closeMov('grp-mov');grpMems.clear();upsertChat(chat);renderChatList();openChat(chat.id);
}

function openChDisc(){openMov('ch-disc-mov');loadChs();}
async function loadChs(q=''){
  const el=document.getElementById('ch-dl');el.innerHTML='<div class="empty-n">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  const r=await api('/api/channels?q='+encodeURIComponent(q));if(!r.ok)return;
  const list=await r.json();if(!list.length){el.innerHTML='<div class="empty-n">–ö–∞–Ω–∞–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
  el.innerHTML=list.map(c=>{
    const isMem=c.members?.some(m=>m.id===me.id);
    const vb=c.verified?'<span class="verified-inline">‚úì</span>':'';
    return`<div class="uli" onclick="openChDetail('${c.id}')">
      <div class="ava">${avH(c,'sm')}</div>
      <div style="flex:1;min-width:0">
        <div class="uli-n">üì¢ ${esc(c.name)}${vb}${c.username?`<span style="color:var(--tx3);font-size:11px;font-weight:400"> @${esc(c.username)}</span>`:''}${isMem?'<span style="font-size:10px;color:var(--grn);margin-left:4px">‚úì –ü–æ–¥–ø–∏—Å–∞–Ω</span>':''}</div>
        <div class="uli-s">${c.subscribersCount||0} –ø–æ–¥–ø.${c.description?' ¬∑ '+esc(c.description.slice(0,50)):''}</div>
      </div></div>`;
  }).join('');
}
async function openChDetail(id){
  // Navigate to channel (subscribe if not member)
  const chat=chats.find(c=>c.id===id);
  if(chat){closeMov('ch-disc-mov');openChat(chat.id);return;}
  // Subscribe first
  const r=await api(`/api/chats/${id}/subscribe`,'POST',{});if(!r.ok)return;
  const c=await r.json();upsertChat(c);renderChatList();closeMov('ch-disc-mov');openChat(c.id);
}

function previewChAva(inp){if(!inp.files[0])return;chAvaFile=inp.files[0];const reader=new FileReader();reader.onload=e=>{document.getElementById('ch-ava-prev').innerHTML=`<img src="${e.target.result}">`;};reader.readAsDataURL(inp.files[0]);}
async function createCh(){
  const name=document.getElementById('ch-cn').value.trim();
  const un=document.getElementById('ch-cu').value.trim().toLowerCase().replace(/[^a-z0-9_.]/g,'');
  const desc=document.getElementById('ch-cd').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  if(!un||un.length<3){alert('Username –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)');return;}
  const r=await api('/api/chats/channel','POST',{name,username:un,description:desc});
  if(!r.ok){const e=await r.json();alert(e.error);return;}
  let chat=await r.json();
  if(chAvaFile){const fd=new FormData();fd.append('file',chAvaFile,chAvaFile.name);const ar=await fetch(`/api/chats/${chat.id}/avatar`,{method:'POST',headers:{Authorization:`Bearer ${token}`},body:fd});if(ar.ok){const ad=await ar.json();chat.avatar=ad.avatar;}}
  chAvaFile=null;closeMov('ch-create-mov');upsertChat(chat);renderChatList();openChat(chat.id);
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ PROFILE ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
async function openUserProfile(userId){
  const r=await api(`/api/users/${userId}`);if(!r.ok)return;
  const user=await r.json();renderProfilePanel(user,user.id===me.id);openPov('–ü—Ä–æ—Ñ–∏–ª—å');
}
function renderProfilePanel(user,isMe){
  const od=user.online?'<div class="on-dot lg"></div>':'';
  const joined=new Date(user.createdAt).toLocaleDateString(lang==='en'?'en-US':'ru-RU',{day:'numeric',month:'long',year:'numeric'});
  const bday=user.birthday?new Date(user.birthday+'T00:00:00').toLocaleDateString(lang==='en'?'en-US':'ru-RU',{day:'numeric',month:'long'}):null;
  const isNm=user.username==='nightmare';
  document.getElementById('p-body').innerHTML=`
    <div class="pf-cov"></div>
    <div class="pf-avw"><div class="ava" style="position:relative">${avH({...user,displayName:user.displayName||user.username},'xl')}${od}${user.verified?'<div class="verified-badge">‚úì</div>':''}</div></div>
    <div class="pf-nm">${esc(user.displayName||user.username)}${user.verified?'<span class="verified-inline">‚úì</span>':''}</div>
    ${isNm?`<div style="text-align:center;margin-bottom:6px"><span class="pf-creator">‚ö° #—Å–æ–∑–¥–∞—Ç–µ–ª—å_–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞</span></div>`:''}
    <div class="pf-un">@${esc(user.username)}</div>
    ${user.bio?`<div class="pf-bio">${esc(user.bio)}</div>`:''}
    <div class="pf-stats">
      <div class="stat"><div class="stat-v">${user.online?'üü¢ '+(lang==='en'?'Online':'–û–Ω–ª–∞–π–Ω'):'‚ö´ '+(lang==='en'?'Offline':'–û—Ñ—Ñ–ª–∞–π–Ω')}</div><div class="stat-l">${lang==='en'?'Status':'–°—Ç–∞—Ç—É—Å'}</div></div>
      <div class="stat"><div class="stat-v" style="font-size:11px">${joined}</div><div class="stat-l">${lang==='en'?'Joined':'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}</div></div>
      ${bday?`<div class="stat"><div class="stat-v">üéÇ ${bday}</div><div class="stat-l">${lang==='en'?'Birthday':'–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è'}</div></div>`:''}
    </div>
    <div class="pf-acts">
      ${isMe?`<button class="btn-pf pri" onclick="openPfEdit()">‚úèÔ∏è ${T('editProfile')}</button>`
      :`<button class="btn-pf pri" onclick="startDMFromProfile('${user.id}')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>`}
    </div>`;
}
async function startDMFromProfile(uid){closePov();const r=await api('/api/chats/dm','POST',{userId:uid});if(!r.ok)return;const chat=await r.json();upsertChat(chat);renderChatList();openChat(chat.id);}

function openPfEdit(){
  document.getElementById('pf-edit-body').innerHTML=`
    <div>
      <label class="ef-l">–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
      <label class="ava-up" for="ava-file">
        <div class="ava-up-prev" id="ava-prev">${me.avatar?`<img src="${esc(me.avatar)}">`:`<span style="font-size:32px">${(me.displayName||me.username)[0]}</span>`}</div>
        <div style="font-size:12.5px;color:var(--tx2);text-align:center">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ<br><span style="font-size:11px;color:var(--tx3)">JPG, PNG, GIF –¥–æ 5–ú–ë</span></div>
        <input type="file" id="ava-file" accept="image/*" style="display:none" onchange="prevAva(this)">
      </label>
    </div>
    <div><label class="ef-l">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label><input class="ef-i" type="text" id="ef-dn" value="${esc(me.displayName||me.username)}" maxlength="32" oninput="document.getElementById('ef-cc').textContent=this.value.length+'/32'"><div class="cc" id="ef-cc">${(me.displayName||me.username).length}/32</div></div>
    <div><label class="ef-l">–û —Å–µ–±–µ</label><textarea class="ef-ta" id="ef-bio" maxlength="160" oninput="document.getElementById('ef-bc').textContent=this.value.length+'/160'">${esc(me.bio||'')}</textarea><div class="cc" id="ef-bc">${(me.bio||'').length}/160</div></div>
    <div><label class="ef-l">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input class="ef-i" type="date" id="ef-bday" value="${me.birthday||''}"></div>
    <div><label class="ef-l">–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏</label><div class="colors" id="color-picker">${AVCOLS.map(c=>`<div class="csw ${(me.avatarColor||'#2b8af5')===c?'act':''}" style="background:${c}" onclick="selCol('${c}')"></div>`).join('')}</div></div>`;
  openMov('pf-edit-mov');
}
function prevAva(inp){if(!inp.files[0])return;const r=new FileReader();r.onload=e=>{document.getElementById('ava-prev').innerHTML=`<img src="${e.target.result}">`;};r.readAsDataURL(inp.files[0]);}
function selCol(c){window._pc=c;document.querySelectorAll('.csw').forEach(el=>el.classList.toggle('act',el.style.background===c||el.style.backgroundColor===c));}
async function saveProfile(){
  const dn=document.getElementById('ef-dn')?.value.trim();
  const bio=document.getElementById('ef-bio')?.value||'';
  const bday=document.getElementById('ef-bday')?.value||null;
  const avatarColor=window._pc||me.avatarColor;
  let av=me.avatar;
  const fi=document.getElementById('ava-file');
  if(fi?.files[0]){
    const fd=new FormData();fd.append('file',fi.files[0],fi.files[0].name);
    const r=await fetch('/api/avatar',{method:'POST',headers:{Authorization:`Bearer ${token}`},body:fd});
    if(r.ok){const d=await r.json();av=d.avatar;}
  }
  const r=await api('/api/me','PUT',{displayName:dn,bio,birthday:bday,avatar:av,avatarColor});
  if(!r.ok){alert('–û—à–∏–±–∫–∞');return;}
  const updated=await r.json();me={...me,...updated};delete window._pc;
  const acc=accounts.find(a=>a.user.id===me.id);if(acc){acc.user=me;localStorage.setItem('nx-accounts',JSON.stringify(accounts));}
  renderMeBar();closeMov('pf-edit-mov');
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CHAT INFO ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function openChatInfo(){
  if(!curChat)return;const chat=chats.find(c=>c.id===curChat);if(!chat)return;
  if(chat.type==='dm'){const o=chat.members?.find(m=>m.id!==me.id);if(o)openUserProfile(o.id);return;}
  renderGrpPanel(chat);openPov(chat.type==='channel'?'üì¢ –ö–∞–Ω–∞–ª':'üë• –ì—Ä—É–ø–ø–∞');
}
function renderGrpPanel(chat){
  const isAdmin=chat.ownerId===me.id||(chat.roles&&chat.roles[me.id]==='admin');
  const vb=chat.verified?'<span class="verified-inline">‚úì</span>':'';
  let h=`<div style="text-align:center;margin-bottom:16px">
    <div style="display:flex;justify-content:center;margin-bottom:10px"><div class="ava">${avH({...chat,displayName:chat.name},'xl')}</div></div>
    <div style="font-size:18px;font-weight:800;display:flex;align-items:center;justify-content:center;gap:6px">${esc(chat.name)}${vb}</div>
    ${chat.username?`<div style="font-size:12px;color:var(--tx3);margin-top:2px">@${esc(chat.username)}</div>`:''}
    <div style="font-size:12px;color:var(--tx2);margin-top:4px">${chat.type==='channel'?`üì¢ ${chat.members?.length||0} ${T('subscribers')}`:`üë• ${chat.members?.length||0} ${T('members')}`}</div>
    ${chat.description?`<div style="font-size:13px;color:var(--tx2);margin-top:8px;line-height:1.6;padding:0 8px">${esc(chat.description)}</div>`:''}
  </div>
  ${isAdmin?`<div style="margin-bottom:12px"><label class="ava-up" for="chat-ava-inp"><div class="ava-up-prev">${chat.avatar?`<img src="${esc(chat.avatar)}">`:'üì¢'}</div><div style="font-size:12px;color:var(--tx2)">–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</div><input type="file" id="chat-ava-inp" accept="image/*" style="display:none" onchange="uploadChatAva('${chat.id}',this)"></label></div>`:''}
  <div class="sec-l" style="padding:0 0 8px">${chat.type==='channel'?T('subscribers'):T('members')}</div>`;
  (chat.members||[]).forEach(m=>{
    const role=m.id===chat.ownerId?'owner':(chat.roles&&chat.roles[m.id])||null;
    const rb=role?`<span class="m-rbadge ${role}" style="font-size:10px;padding:2px 6px">${role==='owner'?(lang==='en'?'Owner':'–í–ª–∞–¥–µ–ª–µ—Ü'):role==='admin'?(lang==='en'?'Admin':'–ê–¥–º–∏–Ω'):(lang==='en'?'Mod':'–ú–æ–¥.')}</span>`:'';
    const vbm=m.verified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':'';
    h+=`<div class="mem-item" id="mem-${m.id}">
      <div class="ava" style="position:relative">${avH(m,'sm')}${m.online?'<div class="on-dot sm"></div>':''}</div>
      <div class="mem-nm" onclick="openUserProfile('${m.id}')">${esc(m.displayName||m.username)}${vbm}${rb}</div>
      ${isAdmin&&m.id!==me.id?`<button class="ib" onclick="toggleRoleMenu('${chat.id}','${m.id}','${role||''}')">‚ãØ</button>`:''}
    </div>`;
  });
  document.getElementById('p-body').innerHTML=h;
}
function toggleRoleMenu(chatId,userId,curRole){
  const existing=document.getElementById('role-dd-'+userId);if(existing){existing.remove();return;}
  const el=document.createElement('div');el.className='role-dd';el.id='role-dd-'+userId;
  el.innerHTML=`
    <div class="role-opt" onclick="setRole('${chatId}','${userId}','admin')">üëë ${lang==='en'?'Make Admin':'–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º'}</div>
    <div class="role-opt" onclick="setRole('${chatId}','${userId}','mod')">üõ° ${lang==='en'?'Make Moderator':'–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º'}</div>
    ${curRole?`<div class="role-opt" onclick="setRole('${chatId}','${userId}','remove')">‚úï ${lang==='en'?'Remove role':'–°–Ω—è—Ç—å —Ä–æ–ª—å'}</div>`:''}
    <div class="role-opt danger" onclick="kickMember('${chatId}','${userId}')">üö´ ${lang==='en'?'Kick':'–ò—Å–∫–ª—é—á–∏—Ç—å'}</div>`;
  document.getElementById('mem-'+userId).insertAdjacentElement('afterend',el);
}
async function setRole(chatId,userId,role){
  await api(`/api/chats/${chatId}/role/${userId}`,'POST',{role});
  const r=await api('/api/chats');if(r.ok){chats=await r.json();renderChatList();const chat=chats.find(c=>c.id===chatId);if(chat)renderGrpPanel(chat);}
}
async function kickMember(chatId,userId){
  if(!confirm(lang==='en'?'Kick this member?':'–ò—Å–∫–ª—é—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?'))return;
  const r=await api(`/api/chats/${chatId}/kick/${userId}`,'POST',{});
  if(!r.ok){const e=await r.json();alert(e.error);return;}
  const r2=await api('/api/chats');if(r2.ok){chats=await r2.json();renderChatList();const chat=chats.find(c=>c.id===chatId);if(chat)renderGrpPanel(chat);}
}
async function uploadChatAva(chatId,inp){
  if(!inp.files[0])return;
  const fd=new FormData();fd.append('file',inp.files[0],inp.files[0].name);
  const r=await fetch(`/api/chats/${chatId}/avatar`,{method:'POST',headers:{Authorization:`Bearer ${token}`},body:fd});
  if(r.ok){const d=await r.json();const chat=chats.find(c=>c.id===chatId);if(chat){chat.avatar=d.avatar;renderChatList();if(chatId===curChat)updChatHeader(chat);openChatInfo();}}
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ CHAT SETTINGS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
async function openChatSettings(){
  if(!curChat)return;const chat=chats.find(c=>c.id===curChat);if(!chat)return;
  const isMuted=chat.muted||false;
  let isBlocked=false,targetUser=null;
  if(chat.type==='dm'){targetUser=chat.members?.find(m=>m.id!==me.id);if(targetUser){const r=await api(`/api/users/${targetUser.id}/blocked`);if(r.ok){const d=await r.json();isBlocked=d.blocked;}}}
  const isOwner=chat.ownerId===me.id;
  document.getElementById('cs-title').textContent=chat.type==='dm'?(targetUser?.displayName||'–ß–∞—Ç'):esc(chat.name);
  document.getElementById('cs-body').innerHTML=`
    <div class="csi" onclick="toggleMute('${chat.id}',${isMuted})"><div class="csi-ic">${isMuted?'üîî':'üîï'}</div><div class="csi-t"><div class="csi-n">${isMuted?T('unmute'):T('mute')}</div></div></div>
    ${chat.type==='dm'&&targetUser?`
    <div class="csi" onclick="blockUser('${targetUser.id}',${isBlocked})"><div class="csi-ic">${isBlocked?'‚úÖ':'üö´'}</div><div class="csi-t"><div class="csi-n">${isBlocked?T('unblock'):T('block')}</div></div></div>
    <div class="csi" onclick="openUserProfile('${targetUser.id}');closeMov('cs-mov')"><div class="csi-ic">üë§</div><div class="csi-t"><div class="csi-n">${T('profile')}</div><div class="csi-s">@${esc(targetUser.username)}</div></div></div>
    `:chat.type!=='dm'?`<div class="csi" onclick="openChatInfo();closeMov('cs-mov')"><div class="csi-ic">‚ÑπÔ∏è</div><div class="csi-t"><div class="csi-n">${T('members')}</div><div class="csi-s">${chat.members?.length||0}</div></div></div>`:''}
    <div class="csi" onclick="togglePinChat('${chat.id}',${chat.isPinnedByUser||false});closeMov('cs-mov')"><div class="csi-ic">üìå</div><div class="csi-t"><div class="csi-n">${chat.isPinnedByUser?T('unpinChat'):T('pinChat')}</div></div></div>
    <div style="height:1px;background:var(--brd);margin:4px 0"></div>
    <div class="csi" onclick="deleteChat('${chat.id}',${chat.type==='dm'||isOwner})"><div class="csi-ic" style="font-size:18px">üóë</div><div class="csi-t"><div class="csi-n" style="color:var(--red)">${T('deleteChat')}</div><div class="csi-s">${chat.type==='dm'||isOwner?'–î–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤':'–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É'}</div></div></div>`;
  openMov('cs-mov');
}
async function toggleMute(chatId,isMuted){
  await api(`/api/chats/${chatId}/${isMuted?'unmute':'mute'}`,'POST',{});
  const chat=chats.find(c=>c.id===chatId);if(chat)chat.muted=!isMuted;renderChatList();closeMov('cs-mov');
}
async function blockUser(uid,isBlocked){
  await api(`/api/users/${uid}/${isBlocked?'unblock':'block'}`,'POST',{});closeMov('cs-mov');
  alert(isBlocked?(lang==='en'?'Unblocked':'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'):(lang==='en'?'Blocked':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'));
}
async function deleteChat(chatId,canDel){
  if(!canDel){alert('–ù–µ—Ç –ø—Ä–∞–≤');return;}
  if(!confirm(lang==='en'?'Delete chat for everyone?':'–£–¥–∞–ª–∏—Ç—å —á–∞—Ç –¥–ª—è –≤—Å–µ—Ö?'))return;
  await api(`/api/chats/${chatId}/delete`,'POST',{});closeMov('cs-mov');
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ SETTINGS (left panel) ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function openSettings(){renderSettingsBody();document.getElementById('settings-ov').classList.add('open');}
function closeSettings(){document.getElementById('settings-ov').classList.remove('open');}
function renderSettingsBody(){
  renderMeBar();
  const isNm=me.username==='nightmare';
  const b=document.getElementById('s-body');
  b.innerHTML=`
    <!-- Accounts -->
    <div class="s-sec"><div class="s-sec-title">üë§ ${T('accounts')}</div>
      <div class="accs-list">
        ${accounts.map((a,i)=>`<div class="acc-row ${a.user.id===me.id?'active-acc':''}">
          <div class="ava">${avH({...a.user,displayName:a.user.displayName||a.user.username},'sm')}</div>
          <div style="flex:1;min-width:0;cursor:pointer" onclick="switchAccount(${i})"><div class="acc-name">${esc(a.user.displayName||a.user.username)}${a.user.verified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':''}</div><div class="acc-un">@${esc(a.user.username)}</div></div>
          ${a.user.id!==me.id?`<button class="ib" onclick="removeAccount(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>`:''}
        </div>`).join('')}
        ${accounts.length<5?`<div class="add-acc-btn" onclick="openMov('add-acc-mov')">‚ûï ${T('addAccount')}</div>`:''}
      </div>
    </div>
    <!-- Chats -->
    <div class="s-sec"><div class="s-sec-title">üí¨ ${T('chats')}</div>
      <div class="s-row" onclick="openDMM();closeSettings()"><div class="s-ic" style="background:rgba(43,138,245,.15)">üí¨</div><div class="s-info"><div class="s-n">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div></div></div>
      <div class="s-row" onclick="openGrpM();closeSettings()"><div class="s-ic" style="background:rgba(34,197,94,.12)">üë•</div><div class="s-info"><div class="s-n">${T('createGroup')}</div></div></div>
      <div class="s-row" onclick="openChDisc();closeSettings()"><div class="s-ic" style="background:rgba(245,158,11,.12)">üì¢</div><div class="s-info"><div class="s-n">–ö–∞–Ω–∞–ª—ã</div></div></div>
      <div class="s-row" onclick="openMov('ch-create-mov');closeSettings()"><div class="s-ic" style="background:rgba(251,146,60,.12)">üì°</div><div class="s-info"><div class="s-n">${T('createChannel')}</div></div></div>
    </div>
    <!-- Privacy -->
    <div class="s-sec"><div class="s-sec-title">üîí ${T('privacy')}</div>
      <div class="s-row"><div class="s-ic" style="background:rgba(34,197,94,.12)">üëÅ</div><div class="s-info"><div class="s-n">${T('showOnline')}</div><div class="s-s">${setts.showOnline?'–í–∏–¥–Ω–æ':'–°–∫—Ä—ã—Ç–æ'}</div></div><label class="tog" onclick="event.stopPropagation()"><input type="checkbox" ${setts.showOnline?'checked':''} onchange="togSett('showOnline')"><div class="tog-tr"></div><div class="tog-th"></div></label></div>
    </div>
    <!-- Messaging -->
    <div class="s-sec"><div class="s-sec-title">‚å®Ô∏è ${T('messaging')}</div>
      <div class="s-row"><div class="s-ic" style="background:rgba(43,138,245,.12)">‚èé</div><div class="s-info"><div class="s-n">${T('sendEnter')}</div></div><label class="tog" onclick="event.stopPropagation()"><input type="checkbox" ${setts.sendOnEnter?'checked':''} onchange="togSett('sendOnEnter')"><div class="tog-tr"></div><div class="tog-th"></div></label></div>
      <div class="s-row"><div class="s-ic" style="background:rgba(34,197,94,.12)">üîî</div><div class="s-info"><div class="s-n">${T('notifications')}</div></div><label class="tog" onclick="event.stopPropagation()"><input type="checkbox" ${setts.notifications?'checked':''} onchange="togSett('notifications')"><div class="tog-tr"></div><div class="tog-th"></div></label></div>
      <div class="s-row"><div class="s-ic" style="background:rgba(245,158,11,.12)">üîä</div><div class="s-info"><div class="s-n">–ó–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</div></div><label class="tog" onclick="event.stopPropagation()"><input type="checkbox" ${setts.sound?'checked':''} onchange="togSett('sound')"><div class="tog-tr"></div><div class="tog-th"></div></label></div>
    </div>
    <!-- Appearance -->
    <div class="s-sec"><div class="s-sec-title">üé® ${T('appearance')}</div>
      <div class="s-row" onclick=""><div class="s-ic" style="background:rgba(139,92,246,.15)">üåì</div><div class="s-info"><div class="s-n">${T('theme')}</div></div></div>
      <div class="theme-grid" style="padding:4px 8px 10px">
        ${THEMES.map(t=>`<div class="theme-btn ${curTheme===t?'act':''}" style="background:${THEME_COLORS[t]}" onclick="setTheme('${t}');renderSettingsBody()" title="${t}"></div>`).join('')}
      </div>
      <div class="s-row"><div class="s-ic" style="background:rgba(43,138,245,.12)">üåê</div><div class="s-info"><div class="s-n">${T('language')}</div><div class="s-s">${lang==='ru'?'–†—É—Å—Å–∫–∏–π':'English'}</div></div>
        <select style="background:var(--bg4);border:1px solid var(--brd2);border-radius:8px;color:var(--tx);padding:5px 8px;font-size:12px;cursor:pointer" onchange="setLang(this.value)">
          <option value="ru" ${lang==='ru'?'selected':''}>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="en" ${lang==='en'?'selected':''}>üá¨üáß English</option>
        </select>
      </div>
    </div>
    <!-- Profile -->
    <div class="s-sec"><div class="s-sec-title">üë§ ${T('profile')}</div>
      <div class="s-row" onclick="openUserProfile('${me.id}');closeSettings()"><div class="s-ic" style="background:rgba(43,138,245,.15)">üëÅ</div><div class="s-info"><div class="s-n">${T('profile')}</div><div class="s-s">@${me.username}</div></div></div>
      <div class="s-row" onclick="openPfEdit();closeSettings()"><div class="s-ic" style="background:rgba(43,138,245,.15)">‚úèÔ∏è</div><div class="s-info"><div class="s-n">${T('editProfile')}</div></div></div>
    </div>
    ${isNm?`<!-- ADMIN PANEL -->
    <div class="s-sec"><div class="s-sec-title">üõ° ${T('adminPanel')}</div>
      <div class="s-row" onclick="openAdminPanel('users')"><div class="s-ic" style="background:linear-gradient(135deg,#ef4444,#f97316)">üë•</div><div class="s-info"><div class="s-n">${T('allUsers')}</div></div><span class="s-r">‚Üí</span></div>
      <div class="s-row" onclick="openAdminPanel('chats')"><div class="s-ic" style="background:linear-gradient(135deg,#7c5ce4,#2b8af5)">üí¨</div><div class="s-info"><div class="s-n">${T('allChats')}</div></div><span class="s-r">‚Üí</span></div>
    </div>`:''}
    <!-- Danger zone -->
    <div class="s-sec"><div class="s-sec-title"></div>
      <div class="dz" style="display:flex;flex-direction:column;gap:6px">
        <button class="btn-danger" onclick="logout()">üö™ ${T('logout')}</button>
        <button class="btn-danger" onclick="deleteMyAccount()">üóë ${T('deleteAccount')}</button>
      </div>
    </div>
    <div style="text-align:center;padding:12px 0;font-size:11px;color:var(--tx3)">Nexus v4.0 ¬∑ Made with ‚ö°</div>`;
}
function togSett(k){setts[k]=!setts[k];localStorage.setItem('nx-s',JSON.stringify(setts));renderSettingsBody();renderMeBar();}
function setLang(l){lang=l;localStorage.setItem('nx-lang',l);renderSettingsBody();renderChatList();if(curChat)renderMsgs(curChat);}

/* ADMIN PANEL */
async function openAdminPanel(type){
  const pov_el=document.getElementById('pov');
  if(type==='users'){
    const r=await api('/api/admin/users');if(!r.ok)return;const users=await r.json();
    document.getElementById('p-title').textContent='üõ° '+T('allUsers');
    document.getElementById('p-body').innerHTML=users.filter(u=>!u.isCreator).map(u=>`
      <div class="admin-row" style="margin-bottom:6px">
        <div class="ava">${avH({...u,displayName:u.displayName||u.username},'sm')}</div>
        <div class="admin-info">
          <div class="admin-name">${esc(u.displayName||u.username)}${u.verified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':''}${u.isBanned?'<span style="color:var(--red);font-size:10px"> üö´</span>':''}</div>
          <div class="admin-un">@${esc(u.username)} ¬∑ ${u.online?'üü¢':'‚ö´'}</div>
        </div>
        <div class="admin-btns">
          <button class="admin-btn verify" onclick="adminVerifyUser('${u.id}')">${u.verified?'‚úì':'‚úì?'}</button>
          <button class="admin-btn ban" onclick="adminBanUser('${u.id}')">${u.isBanned?'–†–∞–∑–±–ª.':'–ë–∞–Ω'}</button>
          <button class="admin-btn del" onclick="adminDelUser('${u.id}')">üóë</button>
        </div>
      </div>`).join('');
  }else{
    const r=await api('/api/admin/chats');if(!r.ok)return;const chatList=await r.json();
    document.getElementById('p-title').textContent='üõ° '+T('allChats');
    document.getElementById('p-body').innerHTML=chatList.map(c=>`
      <div class="admin-row" style="margin-bottom:6px">
        <div class="ava">${avH({...c,displayName:c.name},'sm')}</div>
        <div class="admin-info">
          <div class="admin-name">${esc(c.name)}${c.verified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':''}</div>
          <div class="admin-un">${c.type}${c.username?' ¬∑ @'+esc(c.username):''}</div>
        </div>
        <div class="admin-btns">
          ${c.type==='channel'||c.type==='group'?`<button class="admin-btn verify" onclick="adminVerifyChat('${c.id}')">${c.verified?'‚úì':'‚úì?'}</button>`:''}
        </div>
      </div>`).join('');
  }
  openPov();closeSettings();
}
async function adminVerifyUser(uid){
  const r=await api(`/api/admin/verify/user/${uid}`,'POST',{});if(!r.ok)return;
  openAdminPanel('users');// refresh
}
async function adminVerifyChat(cid){
  const r=await api(`/api/admin/verify/chat/${cid}`,'POST',{});if(!r.ok)return;
  openAdminPanel('chats');
}
async function adminBanUser(uid){
  if(!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?'))return;
  await api(`/api/admin/ban/${uid}`,'POST',{});openAdminPanel('users');
}
async function adminDelUser(uid){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–≤—Å–µ–≥–¥–∞?'))return;
  await api(`/api/admin/user/${uid}`,'DELETE',null);openAdminPanel('users');
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ PANEL & MODALS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function openPov(){document.getElementById('pov').classList.add('open');}
function closePov(){document.getElementById('pov').classList.remove('open');}
function openMov(id){document.getElementById(id).classList.add('open');}
function closeMov(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.mov').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ USER LIST ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function fusr(q,listId,onCl){
  const el=document.getElementById(listId);if(!el)return;
  const lq=(q||'').toLowerCase();
  const filtered=allUsers.filter(u=>!u.deleted&&u.id!==me.id).filter(u=>!lq||u.username.includes(lq)||(u.displayName||'').toLowerCase().includes(lq));
  if(!filtered.length){el.innerHTML='<div class="empty-n">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
  el.innerHTML=filtered.map((u,i)=>`<div class="uli ${grpMems.has(u.id)?'sel':''}">
    <div class="ava" style="position:relative">${avH(u,'sm')}${u.online?'<div class="on-dot sm"></div>':''}</div>
    <div><div class="uli-n">${esc(u.displayName||u.username)}${u.verified?'<span class="verified-inline" style="width:12px;height:12px;font-size:7px">‚úì</span>':''}</div><div class="uli-s">@${esc(u.username)} ¬∑ ${u.online?'üü¢ '+T('online'):'‚ö´ '+T('offline')}</div></div>
  </div>`).join('');
  el.querySelectorAll('.uli').forEach((item,i)=>item.addEventListener('click',()=>onCl(filtered[i])));
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ AVATAR HELPERS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function avH(e,sz='md'){
  const col=e.avatarColor||e.color||'#2b8af5';
  const letter=(e.displayName||e.name||e.username||'?')[0].toUpperCase();
  const cls=sz==='xl'?'av-xl':sz==='lg'?'av-lg':sz==='sm'?'av-sm':sz==='xs'?'av-xs':'av-md';
  const img=e.avatar?`<img src="${e.avatar}" onerror="this.style.display='none'">`:'';
  return`<div class="av ${cls}" style="background:${col}">${img}${!e.avatar?letter:''}</div>`;
}
function renderAv(el,user,sz='md'){
  if(!el||!user)return;
  const col=user.avatarColor||'#2b8af5';const letter=(user.displayName||user.username||'?')[0].toUpperCase();
  const cls=sz==='xl'?'av-xl':sz==='lg'?'av-lg':sz==='sm'?'av-sm':sz==='md'?'av-md':'av-xs';
  el.className=`av ${cls}`;el.style.background=col;
  if(user.avatar){el.innerHTML=`<img src="${user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%" onerror="this.innerHTML='${letter}';this.style.fontSize='14px'">`;}
  else el.textContent=letter;
}

/* ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ UTILS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ */
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtT(ts){const d=new Date(ts),n=new Date();if(d.toDateString()===n.toDateString())return d.toLocaleTimeString(lang==='en'?'en-US':'ru-RU',{hour:'2-digit',minute:'2-digit'});const y=new Date(n);y.setDate(y.getDate()-1);if(d.toDateString()===y.toDateString())return lang==='en'?'yesterday':'–≤—á–µ—Ä–∞';return d.toLocaleDateString(lang==='en'?'en-US':'ru-RU',{day:'numeric',month:'short'});}
function fmtDur(s){return Math.floor(s/60)+':'+(s%60).toString().padStart(2,'0');}
function fsz(b){if(!b)return'';if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function fic(m){if(m.startsWith('image/'))return'üñºÔ∏è';if(m.startsWith('video/'))return'üé¨';if(m.startsWith('audio/'))return'üéµ';if(m.includes('pdf'))return'üìÑ';if(m.includes('zip')||m.includes('rar'))return'üóúÔ∏è';if(m.includes('text'))return'üìù';return'üìé';}
function api(u,m='GET',b=null){const o={method:m,headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'}};if(b!==null&&m!=='GET'&&m!=='DELETE')o.body=JSON.stringify(b);return fetch(u,o);}

init();
</script>
</body>
</html>
