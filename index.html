<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Nexus</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet"/>
<style>
/* ═══════════════════════════════════════════════════════════════════
   CSS VARIABLES & RESET
═══════════════════════════════════════════════════════════════════ */
:root {
  --accent:       #5C5FEF;
  --accent-h:     #4A4DD8;
  --accent-l:     rgba(92,95,239,.12);
  --accent-ll:    rgba(92,95,239,.06);
  --green:        #22C55E;
  --red:          #EF4444;
  --warn:         #F59E0B;

  --bg:           #F0F2F5;
  --bg-s:         #FFFFFF;
  --sidebar-bg:   #FFFFFF;
  --chat-bg:      #EEF0F4;
  --header-bg:    #FFFFFF;
  --input-bg:     #F5F6FA;
  --hover:        rgba(0,0,0,.04);
  --active:       rgba(92,95,239,.1);

  --t1:           #0F0F1A;
  --t2:           #52525B;
  --t3:           #A1A1AA;
  --t4:           #D4D4D8;

  --border:       #E4E4E7;
  --shadow:       0 2px 12px rgba(0,0,0,.08);
  --shadow-lg:    0 8px 32px rgba(0,0,0,.12);

  --msg-out:      #5C5FEF;
  --msg-out-t:    #fff;
  --msg-in:       #FFFFFF;
  --msg-in-t:     #0F0F1A;

  --radius:       14px;
  --radius-s:     8px;
  --sidebar-w:    340px;
  --transition:   .18s cubic-bezier(.4,0,.2,1);
}

[data-theme="dark"] {
  --bg:           #111318;
  --bg-s:         #1C1F26;
  --sidebar-bg:   #161920;
  --chat-bg:      #111318;
  --header-bg:    #161920;
  --input-bg:     #1F232C;
  --hover:        rgba(255,255,255,.05);
  --active:       rgba(92,95,239,.18);

  --t1:           #F4F4F5;
  --t2:           #A1A1AA;
  --t3:           #71717A;
  --t4:           #3F3F46;

  --border:       #27272A;
  --shadow:       0 2px 12px rgba(0,0,0,.3);
  --shadow-lg:    0 8px 32px rgba(0,0,0,.5);

  --msg-in:       #21242C;
  --msg-in-t:     #F4F4F5;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: 'DM Sans', system-ui, sans-serif;
  font-size: 15px;
  background: var(--bg);
  color: var(--t1);
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  transition: background var(--transition), color var(--transition);
}

button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, textarea { font-family: inherit; outline: none; border: none; background: none; }
a { color: inherit; text-decoration: none; }
:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

/* ═══════════════════════════════════════════════════════════════════
   SCROLLBAR
═══════════════════════════════════════════════════════════════════ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--t4); border-radius: 4px; }

/* ═══════════════════════════════════════════════════════════════════
   AUTH SCREEN
═══════════════════════════════════════════════════════════════════ */
#auth-screen {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg);
  z-index: 1000;
  transition: opacity .4s, transform .4s;
}
#auth-screen.hide {
  opacity: 0; transform: scale(.96); pointer-events: none;
}
.auth-card {
  background: var(--bg-s);
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  padding: 48px 44px 44px;
  width: 420px;
  max-width: calc(100vw - 32px);
  animation: slideUp .4s cubic-bezier(.34,1.56,.64,1);
}
@keyframes slideUp {
  from { opacity:0; transform: translateY(24px); }
  to   { opacity:1; transform: translateY(0); }
}
.auth-logo {
  display: flex; align-items: center; gap: 12px;
  justify-content: center; margin-bottom: 32px;
}
.auth-logo-icon {
  width: 52px; height: 52px;
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #5C5FEF 0%, #7C3AED 100%);
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(92,95,239,.4);
}
.auth-logo-text {
  font-size: 28px; font-weight: 700; letter-spacing: -.5px;
  background: linear-gradient(135deg,#5C5FEF,#7C3AED);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.auth-tabs {
  display: flex; background: var(--input-bg);
  border-radius: var(--radius); padding: 4px;
  margin-bottom: 28px; gap: 4px;
}
.auth-tab {
  flex: 1; padding: 9px;
  border-radius: calc(var(--radius) - 2px);
  font-size: 14px; font-weight: 600; color: var(--t2);
  transition: all var(--transition);
  text-align: center;
}
.auth-tab.active {
  background: var(--bg-s); color: var(--accent);
  box-shadow: 0 1px 6px rgba(0,0,0,.08);
}
.auth-form { display: flex; flex-direction: column; gap: 14px; }
.input-group { position: relative; }
.input-group label {
  display: block; font-size: 12px; font-weight: 600;
  color: var(--t2); margin-bottom: 6px; letter-spacing: .3px;
  text-transform: uppercase;
}
.input-field {
  width: 100%; padding: 12px 16px;
  background: var(--input-bg); border: 1.5px solid transparent;
  border-radius: var(--radius); font-size: 15px; color: var(--t1);
  transition: border-color var(--transition), box-shadow var(--transition);
}
.input-field:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-l);
}
.input-field::placeholder { color: var(--t3); }
.btn-primary {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, var(--accent), #7C3AED);
  color: #fff; border-radius: var(--radius);
  font-size: 15px; font-weight: 600;
  transition: all var(--transition);
  margin-top: 4px;
  box-shadow: 0 4px 14px rgba(92,95,239,.35);
}
.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(92,95,239,.5);
}
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: .6; transform: none; cursor: not-allowed; }
.auth-error {
  background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.2);
  color: var(--red); border-radius: var(--radius-s);
  padding: 10px 14px; font-size: 13px; font-weight: 500;
  animation: shake .3s ease;
}
@keyframes shake {
  0%,100%{ transform: translateX(0); }
  25%{ transform: translateX(-6px); }
  75%{ transform: translateX(6px); }
}

/* ═══════════════════════════════════════════════════════════════════
   APP LAYOUT
═══════════════════════════════════════════════════════════════════ */
#app {
  display: none; height: 100dvh;
  flex-direction: row;
}
#app.visible { display: flex; }

/* ═══════════════════════════════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════════════════════════════ */
#sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  display: flex; flex-direction: column;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  height: 100%;
  transition: transform var(--transition);
  z-index: 10;
}
.sidebar-header {
  padding: 12px 14px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--header-bg);
}
.sidebar-top {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 10px;
}
.sidebar-logo {
  display: flex; align-items: center; gap: 9px; flex: 1;
}
.sidebar-logo-icon {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), #7C3AED);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.sidebar-logo-text {
  font-size: 18px; font-weight: 700; letter-spacing: -.3px;
  background: linear-gradient(135deg, var(--accent), #7C3AED);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.icon-btn {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  color: var(--t2); transition: all var(--transition);
  flex-shrink: 0;
}
.icon-btn:hover { background: var(--hover); color: var(--accent); }
.icon-btn svg { pointer-events: none; }

.search-box {
  position: relative;
}
.search-input {
  width: 100%; padding: 9px 14px 9px 38px;
  background: var(--input-bg); border-radius: 12px;
  font-size: 14px; color: var(--t1);
  transition: all var(--transition);
  border: 1.5px solid transparent;
}
.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-l);
}
.search-input::placeholder { color: var(--t3); }
.search-icon {
  position: absolute; left: 11px; top: 50%;
  transform: translateY(-50%); color: var(--t3); pointer-events: none;
}
.search-results {
  position: absolute; top: 100%; left: 0; right: 0;
  background: var(--bg-s); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  max-height: 280px; overflow-y: auto; z-index: 20;
  margin-top: 4px; display: none;
}
.search-results.show { display: block; }
.search-result-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; cursor: pointer;
  transition: background var(--transition);
}
.search-result-item:hover { background: var(--hover); }

/* Chat list */
#chat-list {
  flex: 1; overflow-y: auto; padding: 4px 0;
}
.chat-item {
  display: flex; align-items: center; gap: 11px;
  padding: 10px 14px; cursor: pointer;
  transition: background var(--transition); position: relative;
}
.chat-item:hover { background: var(--hover); }
.chat-item.active { background: var(--active); }
.chat-item.active .chat-name { color: var(--accent); }

.avatar {
  width: 44px; height: 44px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 700; color: #fff;
  flex-shrink: 0; position: relative;
  text-transform: uppercase; user-select: none;
}
.avatar-sm { width: 32px; height: 32px; font-size: 12px; border-radius: 50%; flex-shrink:0; display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700; }
.online-dot {
  position: absolute; bottom: 1px; right: 1px;
  width: 11px; height: 11px; border-radius: 50%;
  background: var(--green); border: 2px solid var(--sidebar-bg);
}
.chat-info { flex: 1; min-width: 0; }
.chat-name {
  font-size: 14.5px; font-weight: 600; color: var(--t1);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 2px;
}
.chat-last {
  font-size: 13px; color: var(--t2);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.chat-meta {
  display: flex; flex-direction: column; align-items: flex-end; gap: 4px;
  flex-shrink: 0;
}
.chat-time { font-size: 11.5px; color: var(--t3); }
.unread-badge {
  background: var(--accent); color: #fff;
  border-radius: 12px; padding: 1px 7px;
  font-size: 11.5px; font-weight: 700;
  min-width: 20px; text-align: center;
}

/* Sidebar footer */
.sidebar-footer {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
  background: var(--header-bg);
}
.sidebar-user {
  flex: 1; display: flex; align-items: center; gap: 9px;
  cursor: pointer; border-radius: 10px; padding: 6px 8px;
  transition: background var(--transition);
}
.sidebar-user:hover { background: var(--hover); }
.sidebar-user-name {
  font-size: 13.5px; font-weight: 600; color: var(--t1);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.sidebar-user-status { font-size: 12px; color: var(--green); }

/* ═══════════════════════════════════════════════════════════════════
   CHAT AREA
═══════════════════════════════════════════════════════════════════ */
#chat-area {
  flex: 1; display: flex; flex-direction: column;
  height: 100%; overflow: hidden;
  background: var(--chat-bg);
  position: relative;
}

/* Empty state */
#empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 16px;
  color: var(--t3);
}
.empty-icon {
  width: 80px; height: 80px;
  background: var(--accent-l);
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
}
#empty-state h3 { font-size: 20px; color: var(--t2); font-weight: 600; }
#empty-state p  { font-size: 14px; color: var(--t3); }

/* Chat header */
#chat-header {
  display: none; align-items: center; gap: 11px;
  padding: 10px 16px;
  background: var(--header-bg);
  border-bottom: 1px solid var(--border);
  min-height: 60px; flex-shrink: 0;
  box-shadow: var(--shadow);
  z-index: 5;
}
#chat-header.visible { display: flex; }
.chat-header-info { flex: 1; min-width: 0; }
.chat-header-name {
  font-size: 15.5px; font-weight: 700; color: var(--t1);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.chat-header-status { font-size: 12.5px; color: var(--t3); transition: color var(--transition); }
.chat-header-status.online { color: var(--green); }
.typing-text { font-style: italic; color: var(--accent) !important; }

/* Messages */
#messages-area {
  display: none; flex: 1; overflow-y: auto;
  padding: 16px 16px 8px;
  scroll-behavior: smooth;
  position: relative;
}
#messages-area.visible { display: block; }

.load-more {
  text-align: center; margin-bottom: 12px;
}
.load-more button {
  padding: 6px 18px; border-radius: 20px;
  background: var(--bg-s); color: var(--t2);
  font-size: 13px; font-weight: 500;
  border: 1px solid var(--border);
  transition: all var(--transition);
}
.load-more button:hover { background: var(--hover); color: var(--accent); }

/* Date divider */
.date-divider {
  text-align: center; margin: 12px 0;
  position: relative;
}
.date-divider::before {
  content: '';
  position: absolute; top: 50%; left: 0; right: 0;
  height: 1px; background: var(--border);
}
.date-divider span {
  position: relative; z-index: 1;
  background: var(--chat-bg); padding: 0 12px;
  font-size: 12px; color: var(--t3); font-weight: 500;
}

/* Message row */
.msg-row {
  display: flex; margin-bottom: 2px;
  animation: msgIn .2s cubic-bezier(.34,1.4,.64,1);
}
@keyframes msgIn {
  from { opacity:0; transform: translateY(8px) scale(.97); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}
.msg-row.outgoing { justify-content: flex-end; }
.msg-row.incoming { justify-content: flex-start; }
.msg-row.with-avatar { margin-top: 6px; }

.msg-avatar-col {
  width: 30px; flex-shrink: 0;
  margin-right: 6px; display: flex;
  align-items: flex-end; padding-bottom: 2px;
}
.msg-avatar-small {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: #fff;
  flex-shrink: 0;
}

.msg-bubble {
  max-width: 68%; padding: 9px 13px;
  border-radius: 18px;
  position: relative; word-break: break-word;
  line-height: 1.5;
}
.msg-row.outgoing .msg-bubble {
  background: var(--msg-out); color: var(--msg-out-t);
  border-bottom-right-radius: 5px;
}
.msg-row.incoming .msg-bubble {
  background: var(--msg-in); color: var(--msg-in-t);
  border-bottom-left-radius: 5px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.msg-row.first-in-group.incoming .msg-bubble { border-top-left-radius: 18px; }
.msg-row.first-in-group.outgoing .msg-bubble { border-top-right-radius: 18px; }

.msg-sender-name {
  font-size: 12px; font-weight: 700; margin-bottom: 3px;
}
.msg-text { font-size: 14.5px; }
.msg-meta {
  display: flex; align-items: center; justify-content: flex-end;
  gap: 3px; margin-top: 4px;
}
.msg-time { font-size: 11px; opacity: .7; }
.msg-status svg { opacity: .85; }
.msg-status.read svg path { fill: #fff; opacity: 1; }
.msg-row.incoming .msg-status.read svg path { fill: var(--accent); }

/* Typing indicator bubble */
.typing-indicator-row {
  display: flex; align-items: flex-end; gap: 6px;
  margin-bottom: 6px; animation: msgIn .2s ease;
}
.typing-bubble {
  background: var(--msg-in); border-radius: 18px; border-bottom-left-radius: 5px;
  padding: 11px 16px; display: flex; gap: 4px; align-items: center;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.typing-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--t3); animation: typingBounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: .2s; }
.typing-dot:nth-child(3) { animation-delay: .4s; }
@keyframes typingBounce {
  0%,60%,100% { transform: translateY(0); opacity:.5; }
  30%          { transform: translateY(-5px); opacity:1; }
}

/* Input area */
#chat-input-area {
  display: none; padding: 10px 14px 12px;
  background: var(--header-bg);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
#chat-input-area.visible { display: flex; align-items: flex-end; gap: 9px; }

.input-wrapper {
  flex: 1; background: var(--input-bg);
  border-radius: 22px; border: 1.5px solid transparent;
  display: flex; align-items: flex-end;
  padding: 8px 14px; gap: 8px;
  transition: border-color var(--transition), box-shadow var(--transition);
  min-height: 44px;
}
.input-wrapper:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-l);
}
#msg-input {
  flex: 1; font-size: 14.5px; color: var(--t1);
  resize: none; line-height: 1.5;
  max-height: 120px; overflow-y: auto;
  background: transparent;
  padding: 2px 0;
}
#msg-input::placeholder { color: var(--t3); }
.send-btn {
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  color: white; flex-shrink: 0;
  transition: all var(--transition);
  box-shadow: 0 2px 10px rgba(92,95,239,.35);
}
.send-btn:hover { background: var(--accent-h); transform: scale(1.05); }
.send-btn:active { transform: scale(.95); }
.send-btn:disabled { opacity: .5; transform: none; cursor: not-allowed; }

/* ═══════════════════════════════════════════════════════════════════
   MODAL
═══════════════════════════════════════════════════════════════════ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.45); backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  animation: fadeIn .15s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal {
  background: var(--bg-s); border-radius: 20px;
  box-shadow: var(--shadow-lg); padding: 28px;
  width: 100%; max-width: 420px;
  animation: slideUp .2s cubic-bezier(.34,1.3,.64,1);
}
.modal-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px;
}
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: var(--t3); transition: all var(--transition);
}
.modal-close:hover { background: var(--hover); color: var(--t1); }
.modal-form { display: flex; flex-direction: column; gap: 14px; }
.modal-search-results {
  max-height: 200px; overflow-y: auto;
  border: 1px solid var(--border); border-radius: var(--radius);
  margin-top: -6px;
}
.modal-user-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; cursor: pointer;
  transition: background var(--transition);
}
.modal-user-item:hover { background: var(--hover); }
.modal-user-item.selected { background: var(--active); }
.modal-user-name { font-size: 14px; font-weight: 600; }
.modal-user-username { font-size: 12px; color: var(--t3); }
.selected-chips {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: -6px;
}
.chip {
  display: flex; align-items: center; gap: 5px;
  background: var(--accent-l); color: var(--accent);
  border-radius: 20px; padding: 4px 10px 4px 4px;
  font-size: 12.5px; font-weight: 600;
}
.chip-remove {
  width: 16px; height: 16px; border-radius: 50%;
  background: var(--accent); color: white;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; cursor: pointer;
}
.btn-row { display: flex; gap: 10px; margin-top: 4px; }
.btn-secondary {
  flex: 1; padding: 11px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius); font-size: 14px; font-weight: 600;
  color: var(--t2); transition: all var(--transition);
}
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-accent {
  flex: 1; padding: 11px;
  background: var(--accent); color: white;
  border-radius: var(--radius); font-size: 14px; font-weight: 600;
  transition: all var(--transition);
}
.btn-accent:hover { background: var(--accent-h); }
.btn-accent:disabled { opacity:.5; cursor:not-allowed; }

/* ═══════════════════════════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════════════════════════ */
#toast-container {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%);
  z-index: 9999; display: flex; flex-direction: column;
  align-items: center; gap: 8px; pointer-events: none;
}
.toast {
  background: #1A1A2E; color: #fff;
  padding: 10px 20px; border-radius: 24px;
  font-size: 13.5px; font-weight: 500;
  box-shadow: 0 4px 20px rgba(0,0,0,.3);
  animation: toastIn .25s ease;
  pointer-events: none;
}
[data-theme="dark"] .toast { background: #E4E4E7; color: #111; }
@keyframes toastIn {
  from { opacity:0; transform:translateY(10px) scale(.96); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}

/* ═══════════════════════════════════════════════════════════════════
   MOBILE RESPONSIVE
═══════════════════════════════════════════════════════════════════ */
@media (max-width: 768px) {
  #sidebar {
    position: fixed; left: 0; top: 0; bottom: 0;
    width: 100%; min-width: 100%;
    transform: translateX(0);
    transition: transform .28s cubic-bezier(.4,0,.2,1);
  }
  #sidebar.mobile-hidden {
    transform: translateX(-100%);
  }
  #chat-area {
    position: fixed; left: 0; top: 0; bottom: 0; right: 0;
    transform: translateX(100%);
    transition: transform .28s cubic-bezier(.4,0,.2,1);
  }
  #chat-area.mobile-visible {
    transform: translateX(0);
  }
  #back-btn { display: flex !important; }
  .msg-bubble { max-width: 82%; }
  .auth-card { padding: 36px 24px 28px; }
  .modal { padding: 22px 18px; }
}

#back-btn { display: none; }

/* ═══════════════════════════════════════════════════════════════════
   CONTEXT MENU (right-click)
═══════════════════════════════════════════════════════════════════ */
.ctx-menu {
  position: fixed; z-index: 500;
  background: var(--bg-s); border: 1px solid var(--border);
  border-radius: var(--radius-s); box-shadow: var(--shadow-lg);
  padding: 4px;
  animation: fadeIn .12s ease;
  min-width: 160px;
}
.ctx-item {
  padding: 9px 14px; font-size: 13.5px;
  cursor: pointer; border-radius: 6px;
  transition: background var(--transition);
  display: flex; align-items: center; gap: 8px; color: var(--t1);
}
.ctx-item:hover { background: var(--hover); }
.ctx-item.danger { color: var(--red); }

/* ═══════════════════════════════════════════════════════════════════
   MISC
═══════════════════════════════════════════════════════════════════ */
.empty-chats {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 200px; gap: 10px;
  color: var(--t3);
}
.empty-chats p { font-size: 14px; text-align: center; padding: 0 24px; }
.section-label {
  padding: 8px 16px 4px;
  font-size: 11px; font-weight: 700;
  color: var(--t3); letter-spacing: .8px; text-transform: uppercase;
}
.divider { height: 1px; background: var(--border); margin: 4px 0; }
</style>
</head>
<body>

<!-- ═══════════════════════════════ AUTH SCREEN ═══════════════════ -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">
        <svg width="30" height="30" viewBox="0 0 30 30" fill="none">
          <circle cx="15" cy="8"  r="3.5" fill="white"/>
          <circle cx="7"  cy="22" r="3.5" fill="white"/>
          <circle cx="23" cy="22" r="3.5" fill="white"/>
          <line x1="15" y1="8"  x2="7"  y2="22" stroke="white" stroke-width="2" stroke-opacity=".7"/>
          <line x1="15" y1="8"  x2="23" y2="22" stroke="white" stroke-width="2" stroke-opacity=".7"/>
          <line x1="7"  y1="22" x2="23" y2="22" stroke="white" stroke-width="2" stroke-opacity=".7"/>
        </svg>
      </div>
      <span class="auth-logo-text">Nexus</span>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login"    onclick="switchTab('login')">Войти</button>
      <button class="auth-tab"        id="tab-register" onclick="switchTab('register')">Регистрация</button>
    </div>

    <form class="auth-form" id="auth-form" onsubmit="handleAuth(event)">
      <div id="field-display-name" style="display:none">
        <div class="input-group">
          <label>Имя</label>
          <input class="input-field" type="text" id="input-display-name" placeholder="Ваше имя" maxlength="64" autocomplete="off"/>
        </div>
      </div>
      <div class="input-group">
        <label>Username</label>
        <input class="input-field" type="text" id="input-username" placeholder="username" maxlength="32" autocomplete="username" required/>
      </div>
      <div class="input-group">
        <label>Пароль</label>
        <input class="input-field" type="password" id="input-password" placeholder="••••••••" autocomplete="current-password" required/>
      </div>
      <div id="auth-error" style="display:none" class="auth-error"></div>
      <button type="submit" class="btn-primary" id="auth-submit">Войти</button>
    </form>
  </div>
</div>

<!-- ═══════════════════════════════ MAIN APP ══════════════════════ -->
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-top">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
              <circle cx="11" cy="5"  r="2.8" fill="white"/>
              <circle cx="4"  cy="17" r="2.8" fill="white"/>
              <circle cx="18" cy="17" r="2.8" fill="white"/>
              <line x1="11" y1="5" x2="4"  y2="17" stroke="white" stroke-width="1.5" stroke-opacity=".7"/>
              <line x1="11" y1="5" x2="18" y2="17" stroke="white" stroke-width="1.5" stroke-opacity=".7"/>
              <line x1="4"  y1="17" x2="18" y2="17" stroke="white" stroke-width="1.5" stroke-opacity=".7"/>
            </svg>
          </div>
          <span class="sidebar-logo-text">Nexus</span>
        </div>
        <button class="icon-btn" onclick="openNewChatModal()" title="Новый чат">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="toggleTheme()" title="Тема" id="theme-btn">
          <svg id="theme-icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="12" cy="12" r="4"/>
            <line x1="12" y1="2"  x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/>
            <line x1="4.22" y1="4.22"  x2="6.34" y2="6.34"/>
            <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
            <line x1="2" y1="12"  x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/>
            <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>
            <line x1="17.66" y1="6.34"  x2="19.78" y2="4.22"/>
          </svg>
          <svg id="theme-icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>
      <div class="search-box" style="position:relative">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
          <circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input class="search-input" id="search-input" type="text" placeholder="Поиск чатов и пользователей..." autocomplete="off" oninput="handleSearch(this.value)"/>
        <div id="search-results" class="search-results"></div>
      </div>
    </div>

    <div id="chat-list"></div>

    <div class="sidebar-footer">
      <div class="sidebar-user" onclick="showProfile()">
        <div class="avatar avatar-sm" id="sidebar-avatar" style="width:36px;height:36px;font-size:13px;border-radius:50%"></div>
        <div style="flex:1;min-width:0">
          <div class="sidebar-user-name" id="sidebar-name"></div>
          <div class="sidebar-user-status">● в сети</div>
        </div>
      </div>
      <button class="icon-btn" onclick="logout()" title="Выйти">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div id="chat-area">
    <!-- Empty state -->
    <div id="empty-state" style="display:flex;flex:1;flex-direction:column;align-items:center;justify-content:center;gap:16px">
      <div class="empty-icon">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </div>
      <h3>Выберите чат</h3>
      <p>Откройте существующий диалог или начните новый</p>
    </div>

    <!-- Chat header -->
    <div id="chat-header">
      <button id="back-btn" class="icon-btn" onclick="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      </button>
      <div id="chat-header-avatar" class="avatar" style="width:40px;height:40px;font-size:15px"></div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="chat-header-name"></div>
        <div class="chat-header-status" id="chat-header-status"></div>
      </div>
      <button class="icon-btn" onclick="showChatInfo()" title="Информация">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16" stroke-width="2.5"/>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="messages-area"></div>

    <!-- Input -->
    <div id="chat-input-area">
      <div class="input-wrapper">
        <textarea id="msg-input" rows="1" placeholder="Написать сообщение…" oninput="autoResizeInput(this);handleTyping()" onkeydown="handleInputKey(event)"></textarea>
      </div>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M22 2L11 13" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════ MODALS ════════════════════════ -->

<!-- New Chat Modal -->
<div id="modal-new-chat" style="display:none">
  <div class="modal-overlay" onclick="if(event.target===this)closeModal('modal-new-chat')">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Новый чат</span>
        <button class="modal-close" onclick="closeModal('modal-new-chat')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button class="btn-secondary" onclick="closeModal('modal-new-chat');openDirectChatModal()" style="text-align:left;padding:14px 16px;display:flex;align-items:center;gap:12px">
          <div style="width:40px;height:40px;border-radius:50%;background:var(--accent-l);display:flex;align-items:center;justify-content:center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div>
            <div style="font-size:14.5px;font-weight:600">Личный чат</div>
            <div style="font-size:12.5px;color:var(--t3)">Начать переписку с пользователем</div>
          </div>
        </button>
        <button class="btn-secondary" onclick="closeModal('modal-new-chat');openGroupModal()" style="text-align:left;padding:14px 16px;display:flex;align-items:center;gap:12px">
          <div style="width:40px;height:40px;border-radius:50%;background:var(--accent-l);display:flex;align-items:center;justify-content:center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div>
            <div style="font-size:14.5px;font-weight:600">Группа</div>
            <div style="font-size:12.5px;color:var(--t3)">Создать групповой чат</div>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Direct Chat Modal -->
<div id="modal-direct" style="display:none">
  <div class="modal-overlay" onclick="if(event.target===this)closeModal('modal-direct')">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Личный чат</span>
        <button class="modal-close" onclick="closeModal('modal-direct')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-form">
        <div class="input-group">
          <label>Найти пользователя</label>
          <input class="input-field" id="direct-search" type="text" placeholder="Введите username..." autocomplete="off" oninput="searchUsersForDirect(this.value)"/>
        </div>
        <div id="direct-results" class="modal-search-results" style="display:none"></div>
      </div>
    </div>
  </div>
</div>

<!-- Group Modal -->
<div id="modal-group" style="display:none">
  <div class="modal-overlay" onclick="if(event.target===this)closeModal('modal-group')">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Создать группу</span>
        <button class="modal-close" onclick="closeModal('modal-group')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-form">
        <div class="input-group">
          <label>Название группы</label>
          <input class="input-field" id="group-name" type="text" placeholder="Название..." maxlength="64" autocomplete="off"/>
        </div>
        <div class="input-group">
          <label>Добавить участников</label>
          <input class="input-field" id="group-member-search" type="text" placeholder="Поиск пользователей..." autocomplete="off" oninput="searchUsersForGroup(this.value)"/>
        </div>
        <div id="group-member-results" class="modal-search-results" style="display:none"></div>
        <div id="group-selected-chips" class="selected-chips"></div>
        <div class="btn-row">
          <button class="btn-secondary" onclick="closeModal('modal-group')">Отмена</button>
          <button class="btn-accent" id="create-group-btn" onclick="createGroup()">Создать</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Info Modal -->
<div id="modal-chat-info" style="display:none">
  <div class="modal-overlay" onclick="if(event.target===this)closeModal('modal-chat-info')">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="chat-info-title">Информация о чате</span>
        <button class="modal-close" onclick="closeModal('modal-chat-info')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div id="chat-info-body"></div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- ═══════════════════════════════ JAVASCRIPT ════════════════════ -->
<script>
/* ══════════════════════════════════════════════════════════════════
   STATE
══════════════════════════════════════════════════════════════════ */
const state = {
  token       : null,
  user        : null,
  chats       : [],
  activeChatId: null,
  messages    : {},   // chatId → msg[]
  hasMore     : {},   // chatId → bool
  onlineUsers : new Set(),
  typing      : {},   // chatId → Map<userId,name>
  ws          : null,
  wsReady     : false,
  authMode    : 'login',
  searchTimeout: null,
  groupMembers: [],   // selected members for group
  theme       : localStorage.getItem('nexus_theme') || 'light',
};

/* ══════════════════════════════════════════════════════════════════
   INIT
══════════════════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  applyTheme(state.theme);
  const token = localStorage.getItem('nexus_token');
  const user  = JSON.parse(localStorage.getItem('nexus_user') || 'null');
  if (token && user) {
    state.token = token;
    state.user  = user;
    showApp();
  }
  // Close search on outside click
  document.addEventListener('click', e => {
    if (!e.target.closest('.search-box')) hideSearchResults();
    if (!e.target.closest('.ctx-menu'))   removeCtxMenu();
  });
});

/* ══════════════════════════════════════════════════════════════════
   THEME
══════════════════════════════════════════════════════════════════ */
function applyTheme(t) {
  state.theme = t;
  document.documentElement.dataset.theme = t;
  localStorage.setItem('nexus_theme', t);
  document.getElementById('theme-icon-sun' ).style.display = t === 'light' ? '' : 'none';
  document.getElementById('theme-icon-moon').style.display = t === 'dark'  ? '' : 'none';
}
function toggleTheme() {
  applyTheme(state.theme === 'light' ? 'dark' : 'light');
}

/* ══════════════════════════════════════════════════════════════════
   AUTH
══════════════════════════════════════════════════════════════════ */
function switchTab(mode) {
  state.authMode = mode;
  document.getElementById('tab-login').classList.toggle('active', mode === 'login');
  document.getElementById('tab-register').classList.toggle('active', mode === 'register');
  document.getElementById('field-display-name').style.display = mode === 'register' ? 'block' : 'none';
  document.getElementById('auth-submit').textContent = mode === 'login' ? 'Войти' : 'Зарегистрироваться';
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('input-password').autocomplete = mode === 'login' ? 'current-password' : 'new-password';
}

async function handleAuth(e) {
  e.preventDefault();
  const btn      = document.getElementById('auth-submit');
  const errEl    = document.getElementById('auth-error');
  const username = document.getElementById('input-username').value.trim();
  const password = document.getElementById('input-password').value;
  const display  = document.getElementById('input-display-name').value.trim();
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = '...';

  try {
    const body = state.authMode === 'login'
      ? { username, password }
      : { username, password, display_name: display || username };

    const res  = await api('POST', `/api/${state.authMode}`, body);
    state.token = res.token;
    state.user  = res.user;
    localStorage.setItem('nexus_token', res.token);
    localStorage.setItem('nexus_user',  JSON.stringify(res.user));
    showApp();
  } catch(err) {
    errEl.textContent = err.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = state.authMode === 'login' ? 'Войти' : 'Зарегистрироваться';
  }
}

/* ══════════════════════════════════════════════════════════════════
   APP INIT
══════════════════════════════════════════════════════════════════ */
async function showApp() {
  const authEl = document.getElementById('auth-screen');
  const appEl  = document.getElementById('app');
  authEl.classList.add('hide');
  setTimeout(() => authEl.style.display = 'none', 400);
  appEl.classList.add('visible');

  // Sidebar user info
  const av = document.getElementById('sidebar-avatar');
  av.style.background = state.user.avatar_color;
  av.textContent = initials(state.user.display_name);
  document.getElementById('sidebar-name').textContent = state.user.display_name;

  await loadChats();
  connectWS();
}

function logout() {
  state.ws?.close();
  state.token = null;
  state.user  = null;
  state.chats = [];
  state.messages = {};
  state.activeChatId = null;
  localStorage.removeItem('nexus_token');
  localStorage.removeItem('nexus_user');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('app').style.display = '';
  const authEl = document.getElementById('auth-screen');
  authEl.style.display = '';
  authEl.classList.remove('hide');
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('input-username').value = '';
  document.getElementById('input-password').value = '';
  switchTab('login');
}

/* ══════════════════════════════════════════════════════════════════
   WEBSOCKET
══════════════════════════════════════════════════════════════════ */
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${proto}://${location.host}`);
  state.ws = ws;

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'auth', token: state.token }));
  };

  ws.onmessage = e => {
    let msg;
    try { msg = JSON.parse(e.data); } catch { return; }
    handleWsMessage(msg);
  };

  ws.onclose = () => {
    state.wsReady = false;
    setTimeout(() => state.token && connectWS(), 3000);
  };
  ws.onerror = () => ws.close();
}

function wsSend(data) {
  if (state.ws?.readyState === WebSocket.OPEN) {
    state.ws.send(JSON.stringify(data));
  }
}

function handleWsMessage(msg) {
  switch(msg.type) {
    case 'auth_ok':
      state.wsReady = true;
      break;

    case 'new_message':
      handleNewMessage(msg.message, false);
      break;

    case 'message_sent':
      handleMessageSent(msg.temp_id, msg.message);
      break;

    case 'typing':
      handleTypingEvent(msg.chat_id, msg.user_id, msg.name, true);
      break;

    case 'stop_typing':
      handleTypingEvent(msg.chat_id, msg.user_id, null, false);
      break;

    case 'messages_read':
      handleMessagesRead(msg.chat_id, msg.user_id, msg.ids);
      break;

    case 'user_online':
      state.onlineUsers.add(msg.user_id);
      updateOnlineStatus(msg.user_id, true);
      break;

    case 'user_offline':
      state.onlineUsers.delete(msg.user_id);
      updateOnlineStatus(msg.user_id, false, msg.last_seen);
      break;
  }
}

/* ══════════════════════════════════════════════════════════════════
   CHATS
══════════════════════════════════════════════════════════════════ */
async function loadChats() {
  try {
    state.chats = await api('GET', '/api/chats');
    renderChatList();
  } catch(err) {
    console.error(err);
  }
}

function renderChatList() {
  const el = document.getElementById('chat-list');
  if (!state.chats.length) {
    el.innerHTML = `<div class="empty-chats">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--t4)" stroke-width="1.3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <p>Нет диалогов. Нажмите <b>+</b> чтобы начать общение</p>
    </div>`;
    return;
  }
  el.innerHTML = state.chats.map(chat => renderChatItem(chat)).join('');
}

function renderChatItem(chat) {
  const isActive   = chat.id === state.activeChatId;
  const name       = getChatName(chat);
  const color      = getChatColor(chat);
  const ini        = initials(name);
  const isOnline   = chat.type === 'direct' && chat.other_user && state.onlineUsers.has(chat.other_user.id);
  const unread     = chat.unread || 0;
  const lastMsg    = chat.last_message ? truncate(chat.last_message, 38) : '<em style="color:var(--t3)">Нет сообщений</em>';
  const time       = chat.last_message_at ? formatTime(chat.last_message_at) : '';

  return `<div class="chat-item${isActive?' active':''}" data-chat-id="${chat.id}" onclick="openChat(${chat.id})">
    <div class="avatar" style="background:${color}">
      ${ini}
      ${isOnline ? '<span class="online-dot"></span>' : ''}
    </div>
    <div class="chat-info">
      <div class="chat-name">${esc(name)}</div>
      <div class="chat-last">${lastMsg}</div>
    </div>
    <div class="chat-meta">
      ${time ? `<span class="chat-time">${time}</span>` : ''}
      ${unread > 0 ? `<span class="unread-badge">${unread > 99 ? '99+' : unread}</span>` : ''}
    </div>
  </div>`;
}

async function openChat(chatId) {
  if (state.activeChatId === chatId) {
    showMobileChat();
    return;
  }
  // Deselect previous
  document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
  const item = document.querySelector(`[data-chat-id="${chatId}"]`);
  if (item) item.classList.add('active');

  state.activeChatId = chatId;
  const chat = state.chats.find(c => c.id === chatId);
  if (!chat) return;

  // Update header
  const name   = getChatName(chat);
  const color  = getChatColor(chat);
  document.getElementById('chat-header').classList.add('visible');
  const hav = document.getElementById('chat-header-avatar');
  hav.style.background = color;
  hav.textContent = initials(name);
  document.getElementById('chat-header-name').textContent = name;

  const statusEl = document.getElementById('chat-header-status');
  if (chat.type === 'direct' && chat.other_user) {
    const isOnline = state.onlineUsers.has(chat.other_user.id);
    statusEl.textContent = isOnline ? 'в сети' : lastSeenText(chat.other_user.last_seen);
    statusEl.className = 'chat-header-status' + (isOnline ? ' online' : '');
  } else if (chat.type === 'group') {
    const members = await api('GET', `/api/chats/${chatId}/members`);
    statusEl.textContent = `${members.length} участников`;
    statusEl.className = 'chat-header-status';
  }

  document.getElementById('messages-area').classList.add('visible');
  document.getElementById('chat-input-area').classList.add('visible');
  document.getElementById('empty-state').style.display = 'none';

  // Load messages
  if (!state.messages[chatId]) {
    state.messages[chatId] = [];
    await fetchMessages(chatId);
  }
  renderMessages();
  scrollToBottom(true);
  wsSend({ type: 'mark_read', chat_id: chatId });

  // Clear unread in chat list
  const c = state.chats.find(c => c.id === chatId);
  if (c) { c.unread = 0; renderChatList(); }
  document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');

  showMobileChat();
}

async function fetchMessages(chatId, before = null) {
  const params = before ? `?before=${before}&limit=50` : '?limit=50';
  const msgs = await api('GET', `/api/chats/${chatId}/messages${params}`);
  if (!before) {
    state.messages[chatId] = msgs;
  } else {
    state.messages[chatId] = [...msgs, ...state.messages[chatId]];
  }
  state.hasMore[chatId] = msgs.length === 50;
  return msgs;
}

/* ══════════════════════════════════════════════════════════════════
   MESSAGES RENDERING
══════════════════════════════════════════════════════════════════ */
function renderMessages() {
  const area = document.getElementById('messages-area');
  const msgs = state.messages[state.activeChatId] || [];
  const chat = state.chats.find(c => c.id === state.activeChatId);
  if (!chat) return;

  let html = '';

  if (state.hasMore[state.activeChatId]) {
    html += `<div class="load-more"><button onclick="loadMoreMessages()">Загрузить раньше</button></div>`;
  }

  let lastDate = null;
  let lastSenderId = null;

  for (let i = 0; i < msgs.length; i++) {
    const msg = msgs[i];
    const date = new Date(msg.created_at * 1000);
    const dateStr = formatDate(date);

    if (dateStr !== lastDate) {
      html += `<div class="date-divider"><span>${dateStr}</span></div>`;
      lastDate = dateStr;
      lastSenderId = null;
    }

    const isOut    = msg.sender_id === state.user.id;
    const isFirst  = msg.sender_id !== lastSenderId;
    const isGroup  = chat.type === 'group';
    lastSenderId   = msg.sender_id;

    html += renderMessage(msg, isOut, isFirst, isGroup);
  }

  // Typing indicator
  const typingMap = state.typing[state.activeChatId];
  if (typingMap && typingMap.size > 0) {
    const names = [...typingMap.values()].join(', ');
    html += `<div class="typing-indicator-row" id="typing-row">
      <div class="typing-bubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <span style="font-size:12px;color:var(--t3);margin-left:6px">${esc(names)} печатает…</span>
    </div>`;
  }

  area.innerHTML = html;
}

function renderMessage(msg, isOut, isFirst, isGroup) {
  const time    = fmtMsgTime(msg.created_at);
  const chat    = state.chats.find(c => c.id === state.activeChatId);
  const isSentToGroup = chat?.type === 'group';
  const memberCount = (isSentToGroup ? 1 : 1); // simplified
  const status  = getStatus(msg, isOut);

  let senderName = '';
  if (isGroup && !isOut && isFirst) {
    senderName = `<div class="msg-sender-name" style="color:${msg.avatar_color}">${esc(msg.display_name)}</div>`;
  }

  let avatarHtml = '';
  if (!isOut) {
    avatarHtml = `<div class="msg-avatar-col">`;
    if (isFirst) {
      avatarHtml += `<div class="msg-avatar-small" style="background:${msg.avatar_color}">${initials(msg.display_name)}</div>`;
    }
    avatarHtml += `</div>`;
  }

  return `<div class="msg-row ${isOut?'outgoing':'incoming'}${isFirst?' with-avatar first-in-group':''}" data-msg-id="${msg.id}">
    ${!isOut ? avatarHtml : ''}
    <div class="msg-bubble" title="${esc(msg.display_name)} · ${time}">
      ${senderName}
      <div class="msg-text">${esc(msg.content).replace(/\n/g,'<br>')}</div>
      <div class="msg-meta">
        <span class="msg-time">${time}</span>
        ${isOut ? statusIcon(status) : ''}
      </div>
    </div>
  </div>`;
}

function getStatus(msg, isOut) {
  if (!isOut) return null;
  if (msg.read_count > 0) return 'read';
  return 'sent';
}

function statusIcon(status) {
  if (!status) return '';
  if (status === 'read') {
    return `<span class="msg-status read">
      <svg width="16" height="10" viewBox="0 0 16 10" fill="none">
        <path d="M1 5L5 9L15 1" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 5L9 9" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </span>`;
  }
  return `<span class="msg-status sent">
    <svg width="12" height="10" viewBox="0 0 12 10" fill="none">
      <path d="M1 5L4.5 8.5L11 1" stroke="rgba(255,255,255,.8)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </span>`;
}

function scrollToBottom(instant = false) {
  const area = document.getElementById('messages-area');
  if (instant) {
    area.scrollTop = area.scrollHeight;
  } else {
    area.scrollTo({ top: area.scrollHeight, behavior: 'smooth' });
  }
}

/* ══════════════════════════════════════════════════════════════════
   SEND MESSAGE
══════════════════════════════════════════════════════════════════ */
let typingTimer = null;
let isTyping = false;

function handleTyping() {
  if (!state.activeChatId) return;
  if (!isTyping) {
    isTyping = true;
    wsSend({ type: 'typing', chat_id: state.activeChatId });
  }
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => {
    isTyping = false;
  }, 2500);
}

function sendMessage() {
  const input  = document.getElementById('msg-input');
  const content = input.value.trim();
  if (!content || !state.activeChatId) return;

  const tempId = 'tmp_' + Date.now();
  const tempMsg = {
    id: tempId,
    chat_id: state.activeChatId,
    sender_id: state.user.id,
    content,
    created_at: Math.floor(Date.now() / 1000),
    username: state.user.username,
    display_name: state.user.display_name,
    avatar_color: state.user.avatar_color,
    read_count: 0,
    _pending: true,
  };

  // Optimistic UI
  if (!state.messages[state.activeChatId]) state.messages[state.activeChatId] = [];
  state.messages[state.activeChatId].push(tempMsg);

  // Update last message in chat list
  const chat = state.chats.find(c => c.id === state.activeChatId);
  if (chat) {
    chat.last_message = content;
    chat.last_message_at = tempMsg.created_at;
    chat.last_sender_id = state.user.id;
    // Move to top
    state.chats = [chat, ...state.chats.filter(c => c.id !== chat.id)];
    renderChatList();
    document.querySelector(`[data-chat-id="${state.activeChatId}"]`)?.classList.add('active');
  }

  renderMessages();
  scrollToBottom();

  input.value = '';
  input.style.height = '';
  isTyping = false;

  wsSend({ type: 'send_message', chat_id: state.activeChatId, content, temp_id: tempId });
}

function handleInputKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function handleMessageSent(tempId, message) {
  if (!state.messages[message.chat_id]) return;
  const idx = state.messages[message.chat_id].findIndex(m => m.id === tempId);
  if (idx !== -1) {
    state.messages[message.chat_id][idx] = message;
  } else {
    state.messages[message.chat_id].push(message);
  }
  if (message.chat_id === state.activeChatId) {
    renderMessages();
    scrollToBottom();
  }
  updateChatLastMessage(message);
}

function handleNewMessage(message, fromSelf = false) {
  if (!state.messages[message.chat_id]) state.messages[message.chat_id] = [];
  state.messages[message.chat_id].push(message);

  if (message.chat_id === state.activeChatId) {
    renderMessages();
    scrollToBottom();
    wsSend({ type: 'mark_read', chat_id: message.chat_id });
  } else {
    // Increment unread
    const chat = state.chats.find(c => c.id === message.chat_id);
    if (chat) chat.unread = (chat.unread || 0) + 1;
  }
  updateChatLastMessage(message);
}

function updateChatLastMessage(message) {
  const chat = state.chats.find(c => c.id === message.chat_id);
  if (chat) {
    chat.last_message = message.content;
    chat.last_message_at = message.created_at;
    chat.last_sender_id = message.sender_id;
    chat.last_sender_name = message.display_name;
    state.chats = [chat, ...state.chats.filter(c => c.id !== chat.id)];
    renderChatList();
    if (state.activeChatId) {
      document.querySelector(`[data-chat-id="${state.activeChatId}"]`)?.classList.add('active');
    }
  }
}

function handleMessagesRead(chatId, userId, ids) {
  const msgs = state.messages[chatId];
  if (!msgs) return;
  for (const msg of msgs) {
    if (ids.includes(msg.id)) {
      msg.read_count = (msg.read_count || 0) + 1;
    }
  }
  if (chatId === state.activeChatId) {
    renderMessages();
  }
}

/* ══════════════════════════════════════════════════════════════════
   TYPING INDICATOR
══════════════════════════════════════════════════════════════════ */
function handleTypingEvent(chatId, userId, name, isTypingNow) {
  if (!state.typing[chatId]) state.typing[chatId] = new Map();
  if (isTypingNow) {
    state.typing[chatId].set(userId, name);
  } else {
    state.typing[chatId].delete(userId);
  }
  if (chatId === state.activeChatId) {
    const area = document.getElementById('messages-area');
    const existing = document.getElementById('typing-row');
    const typingMap = state.typing[chatId];
    if (typingMap.size > 0) {
      const names = [...typingMap.values()].join(', ');
      const html = `<div class="typing-indicator-row" id="typing-row">
        <div class="typing-bubble">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span style="font-size:12px;color:var(--t3);margin-left:6px">${esc(names)} печатает…</span>
      </div>`;
      if (existing) existing.outerHTML = html;
      else area.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    } else {
      existing?.remove();
    }
    // Update header status
    const statusEl = document.getElementById('chat-header-status');
    if (typingMap.size > 0) {
      const names = [...typingMap.values()].join(', ');
      statusEl.textContent = `${names} печатает…`;
      statusEl.className = 'chat-header-status typing-text';
    } else {
      // Restore original status
      const chat = state.chats.find(c => c.id === chatId);
      if (chat?.type === 'direct' && chat.other_user) {
        const isOnline = state.onlineUsers.has(chat.other_user.id);
        statusEl.textContent = isOnline ? 'в сети' : lastSeenText(chat.other_user.last_seen);
        statusEl.className = 'chat-header-status' + (isOnline ? ' online' : '');
      }
    }
  }
}

/* ══════════════════════════════════════════════════════════════════
   ONLINE STATUS
══════════════════════════════════════════════════════════════════ */
function updateOnlineStatus(userId, isOnline, lastSeen = null) {
  // Update chat list
  state.chats.forEach(c => {
    if (c.type === 'direct' && c.other_user?.id === userId) {
      renderChatList();
      if (state.activeChatId) {
        document.querySelector(`[data-chat-id="${state.activeChatId}"]`)?.classList.add('active');
      }
    }
  });
  // Update header
  if (state.activeChatId) {
    const chat = state.chats.find(c => c.id === state.activeChatId);
    if (chat?.type === 'direct' && chat.other_user?.id === userId) {
      const statusEl = document.getElementById('chat-header-status');
      if (state.typing[state.activeChatId]?.size > 0) return;
      statusEl.textContent = isOnline ? 'в сети' : lastSeenText(lastSeen);
      statusEl.className = 'chat-header-status' + (isOnline ? ' online' : '');
    }
  }
}

/* ══════════════════════════════════════════════════════════════════
   LOAD MORE MESSAGES
══════════════════════════════════════════════════════════════════ */
async function loadMoreMessages() {
  const chatId = state.activeChatId;
  const msgs   = state.messages[chatId] || [];
  if (!msgs.length) return;
  const area     = document.getElementById('messages-area');
  const prevH    = area.scrollHeight;
  const firstId  = msgs[0].id;
  await fetchMessages(chatId, firstId);
  renderMessages();
  area.scrollTop = area.scrollHeight - prevH;
}

/* ══════════════════════════════════════════════════════════════════
   SEARCH
══════════════════════════════════════════════════════════════════ */
function handleSearch(q) {
  clearTimeout(state.searchTimeout);
  if (!q.trim()) {
    hideSearchResults();
    return;
  }
  state.searchTimeout = setTimeout(async () => {
    const users = await api('GET', `/api/users/search?q=${encodeURIComponent(q)}`);
    showSearchResults(users, q);
  }, 250);
}

function showSearchResults(users, q) {
  const el = document.getElementById('search-results');
  if (!users.length) {
    el.innerHTML = `<div style="padding:14px;text-align:center;color:var(--t3);font-size:13px">Не найдено</div>`;
  } else {
    el.innerHTML = users.map(u => `
      <div class="search-result-item" onclick="startDirectChat('${esc(u.username)}')">
        <div class="avatar-sm" style="background:${u.avatar_color}">${initials(u.display_name)}</div>
        <div>
          <div style="font-size:14px;font-weight:600">${esc(u.display_name)}</div>
          <div style="font-size:12px;color:var(--t3)">@${esc(u.username)}</div>
        </div>
      </div>
    `).join('');
  }
  el.classList.add('show');
}

function hideSearchResults() {
  document.getElementById('search-results').classList.remove('show');
  document.getElementById('search-input').value = '';
}

/* ══════════════════════════════════════════════════════════════════
   CREATE CHAT
══════════════════════════════════════════════════════════════════ */
async function startDirectChat(username) {
  hideSearchResults();
  try {
    const chat = await api('POST', '/api/chats', { type: 'direct', username });
    const existing = state.chats.find(c => c.id === chat.id);
    if (!existing) {
      state.chats.unshift(chat);
      renderChatList();
    }
    openChat(chat.id);
    closeModal('modal-direct');
  } catch(err) {
    showToast(err.message);
  }
}

function openNewChatModal()    { document.getElementById('modal-new-chat').style.display = 'flex'; }
function openDirectChatModal() {
  document.getElementById('modal-direct').style.display = 'flex';
  document.getElementById('direct-results').style.display = 'none';
  document.getElementById('direct-search').value = '';
  setTimeout(() => document.getElementById('direct-search').focus(), 50);
}
function openGroupModal() {
  state.groupMembers = [];
  document.getElementById('modal-group').style.display = 'flex';
  document.getElementById('group-name').value = '';
  document.getElementById('group-member-search').value = '';
  document.getElementById('group-member-results').style.display = 'none';
  renderGroupChips();
  setTimeout(() => document.getElementById('group-name').focus(), 50);
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

async function searchUsersForDirect(q) {
  const el = document.getElementById('direct-results');
  if (!q.trim()) { el.style.display = 'none'; return; }
  const users = await api('GET', `/api/users/search?q=${encodeURIComponent(q)}`);
  if (!users.length) {
    el.innerHTML = `<div style="padding:12px;text-align:center;color:var(--t3);font-size:13px">Не найдено</div>`;
  } else {
    el.innerHTML = users.map(u => `
      <div class="modal-user-item" onclick="startDirectChat('${esc(u.username)}');closeModal('modal-direct')">
        <div class="avatar-sm" style="background:${u.avatar_color}">${initials(u.display_name)}</div>
        <div>
          <div class="modal-user-name">${esc(u.display_name)}</div>
          <div class="modal-user-username">@${esc(u.username)}</div>
        </div>
      </div>
    `).join('');
  }
  el.style.display = 'block';
}

async function searchUsersForGroup(q) {
  const el = document.getElementById('group-member-results');
  if (!q.trim()) { el.style.display = 'none'; return; }
  const users = await api('GET', `/api/users/search?q=${encodeURIComponent(q)}`);
  const filtered = users.filter(u => !state.groupMembers.find(m => m.id === u.id));
  if (!filtered.length) {
    el.innerHTML = `<div style="padding:12px;text-align:center;color:var(--t3);font-size:13px">Не найдено</div>`;
  } else {
    el.innerHTML = filtered.map(u => `
      <div class="modal-user-item" onclick="addGroupMember(${JSON.stringify(u).replace(/"/g,'&quot;')})">
        <div class="avatar-sm" style="background:${u.avatar_color}">${initials(u.display_name)}</div>
        <div>
          <div class="modal-user-name">${esc(u.display_name)}</div>
          <div class="modal-user-username">@${esc(u.username)}</div>
        </div>
      </div>
    `).join('');
  }
  el.style.display = 'block';
}

function addGroupMember(user) {
  if (!state.groupMembers.find(m => m.id === user.id)) {
    state.groupMembers.push(user);
    renderGroupChips();
  }
  document.getElementById('group-member-results').style.display = 'none';
  document.getElementById('group-member-search').value = '';
}
function removeGroupMember(id) {
  state.groupMembers = state.groupMembers.filter(m => m.id !== id);
  renderGroupChips();
}
function renderGroupChips() {
  const el = document.getElementById('group-selected-chips');
  el.innerHTML = state.groupMembers.map(m => `
    <div class="chip">
      <div class="avatar-sm" style="background:${m.avatar_color};width:20px;height:20px;font-size:9px;border-radius:50%">${initials(m.display_name)}</div>
      ${esc(m.display_name)}
      <span class="chip-remove" onclick="removeGroupMember(${m.id})">×</span>
    </div>
  `).join('');
}

async function createGroup() {
  const name = document.getElementById('group-name').value.trim();
  if (!name) { showToast('Введите название группы'); return; }
  const btn = document.getElementById('create-group-btn');
  btn.disabled = true;
  try {
    const chat = await api('POST', '/api/chats', {
      type: 'group',
      name,
      member_ids: state.groupMembers.map(m => m.id),
    });
    state.chats.unshift(chat);
    renderChatList();
    openChat(chat.id);
    closeModal('modal-group');
  } catch(err) {
    showToast(err.message);
  } finally {
    btn.disabled = false;
  }
}

/* ══════════════════════════════════════════════════════════════════
   CHAT INFO
══════════════════════════════════════════════════════════════════ */
async function showChatInfo() {
  const chat = state.chats.find(c => c.id === state.activeChatId);
  if (!chat) return;
  document.getElementById('chat-info-title').textContent = getChatName(chat);
  const body = document.getElementById('chat-info-body');

  if (chat.type === 'group') {
    const members = await api('GET', `/api/chats/${chat.id}/members`);
    body.innerHTML = `
      <div style="margin-bottom:16px;color:var(--t2);font-size:13.5px">${members.length} участников</div>
      <div style="display:flex;flex-direction:column;gap:4px">
        ${members.map(m => `
          <div style="display:flex;align-items:center;gap:10px;padding:8px 0">
            <div class="avatar-sm" style="background:${m.avatar_color};width:38px;height:38px;font-size:14px;border-radius:50%">${initials(m.display_name)}</div>
            <div>
              <div style="font-size:14px;font-weight:600">${esc(m.display_name)}</div>
              <div style="font-size:12px;color:var(--t3)">@${esc(m.username)}${m.role==='admin'?' · <span style="color:var(--accent)">Администратор</span>':''}</div>
            </div>
            ${state.onlineUsers.has(m.id)?'<span style="font-size:11px;color:var(--green);margin-left:auto">●</span>':''}
          </div>
        `).join('')}
      </div>
    `;
  } else if (chat.type === 'direct' && chat.other_user) {
    const u = chat.other_user;
    const isOnline = state.onlineUsers.has(u.id);
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px 0">
        <div class="avatar" style="background:${u.avatar_color};width:72px;height:72px;font-size:26px">${initials(u.display_name)}</div>
        <div style="text-align:center">
          <div style="font-size:18px;font-weight:700">${esc(u.display_name)}</div>
          <div style="font-size:13.5px;color:var(--t3)">@${esc(u.username)}</div>
          <div style="font-size:13px;margin-top:4px;color:${isOnline?'var(--green)':'var(--t3)'}">${isOnline?'В сети':lastSeenText(u.last_seen)}</div>
        </div>
      </div>
    `;
  }

  document.getElementById('modal-chat-info').style.display = 'flex';
}

/* ══════════════════════════════════════════════════════════════════
   MOBILE
══════════════════════════════════════════════════════════════════ */
function showMobileChat() {
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.add('mobile-hidden');
    document.getElementById('chat-area').classList.add('mobile-visible');
  }
}
function goBack() {
  document.getElementById('sidebar').classList.remove('mobile-hidden');
  document.getElementById('chat-area').classList.remove('mobile-visible');
}

/* ══════════════════════════════════════════════════════════════════
   TEXTAREA AUTO-RESIZE
══════════════════════════════════════════════════════════════════ */
function autoResizeInput(el) {
  el.style.height = '';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* ══════════════════════════════════════════════════════════════════
   TOAST
══════════════════════════════════════════════════════════════════ */
function showToast(msg, duration = 3000) {
  const c = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(10px)';
    el.style.transition = 'all .25s';
    setTimeout(() => el.remove(), 260);
  }, duration);
}

/* ══════════════════════════════════════════════════════════════════
   CONTEXT MENU
══════════════════════════════════════════════════════════════════ */
function removeCtxMenu() {
  document.querySelector('.ctx-menu')?.remove();
}

/* ══════════════════════════════════════════════════════════════════
   PROFILE PLACEHOLDER
══════════════════════════════════════════════════════════════════ */
function showProfile() {
  showToast(`👤 ${state.user.display_name} (@${state.user.username})`);
}

/* ══════════════════════════════════════════════════════════════════
   API HELPER
══════════════════════════════════════════════════════════════════ */
async function api(method, path, body = null) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (state.token) opts.headers['Authorization'] = 'Bearer ' + state.token;
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Ошибка сервера');
  return data;
}

/* ══════════════════════════════════════════════════════════════════
   UTILS
══════════════════════════════════════════════════════════════════ */
function initials(name) {
  if (!name) return '?';
  const parts = name.trim().split(/\s+/);
  if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
  return name.slice(0, 2).toUpperCase();
}

function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function truncate(str, n) {
  return str.length > n ? str.slice(0, n) + '…' : str;
}

function getChatName(chat) {
  if (chat.type === 'direct' && chat.other_user) return chat.other_user.display_name;
  return chat.name || 'Чат';
}
function getChatColor(chat) {
  if (chat.type === 'direct' && chat.other_user) return chat.other_user.avatar_color;
  return chat.avatar_color || '#5C5FEF';
}

function formatTime(ts) {
  const d = new Date(ts * 1000);
  const now = new Date();
  const diff = now - d;
  if (diff < 86400000 && d.getDate() === now.getDate()) {
    return d.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
  }
  if (diff < 604800000) {
    return d.toLocaleDateString('ru', { weekday: 'short' });
  }
  return d.toLocaleDateString('ru', { day: 'numeric', month: 'short' });
}

function fmtMsgTime(ts) {
  return new Date(ts * 1000).toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(date) {
  const now  = new Date();
  const diff = now - date;
  if (diff < 86400000 && date.getDate() === now.getDate()) return 'Сегодня';
  if (diff < 172800000) return 'Вчера';
  return date.toLocaleDateString('ru', { day: 'numeric', month: 'long', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
}

function lastSeenText(ts) {
  if (!ts) return 'не в сети';
  const d    = new Date(ts * 1000);
  const now  = new Date();
  const diff = now - d;
  if (diff < 60000)  return 'только что в сети';
  if (diff < 3600000) return `в сети ${Math.floor(diff/60000)} мин. назад`;
  if (diff < 86400000 && d.getDate() === now.getDate())
    return `в сети сегодня в ${d.toLocaleTimeString('ru', { hour:'2-digit', minute:'2-digit' })}`;
  if (diff < 172800000)
    return `в сети вчера в ${d.toLocaleTimeString('ru', { hour:'2-digit', minute:'2-digit' })}`;
  return `в сети ${d.toLocaleDateString('ru', { day:'numeric', month:'long' })}`;
}
</script>
</body>
</html>
